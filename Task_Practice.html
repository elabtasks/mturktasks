<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="Task.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="jquery-3.2.1.js"></script>
  <script type="text/javascript" src="math.js"></script>
  <script type="text/javascript" src="images.js"></script>
  <script type="text/javascript">


  $(document).ready(function(){
    $("#form").hide();
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    document.getElementById("myCanvas").style.cursor = "none";

    //#######################################################//
    //-------------GLOBAL EXPERIMENT PARAMETERS--------------//
    //#######################################################//

    //------------------------TIMINGS-----------------------//
    var IMAGEinterval         = 2000
    var ITIinterval           = 500
    var ISIinterval           = 500

    //---------------------TRIAL COUNTS--------------------//
    var numberoftrials        = 32;
    var miniblocklength       = 8;

    //----------------MIND WANDERING PROBES---------------//
    var numberofprimeprobes   = 12;
    var numberofprobeprobes   = 12;
    var MWprobedistance       = 3;
    var MWprobedistancevar    = 1;

    //----------------------SHUFFLE FUNCTION------------------//
    //https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array

    function shuffle(array) {
      for (var i = array.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = array[i];
          array[i] = array[j];
          array[j] = temp;
      }
        return array;
      };

    //#######################################################//
    //-----------------------LOAD IMAGES---------------------//
    //#######################################################//

    var fileName = listimagenames
		var img = new Array(fileName.length);
		var imgCount = 0;

		function loadImage()
		{
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      ctx.font="bold 45px Arial";
      ctx.fillText("The task is loading. Please wait.", (myCanvas.width/2), (myCanvas.height/2)-400);
      ctx.fillText(Math.round((imgCount/fileName.length)*100)+"%", (myCanvas.width/2), (myCanvas.height/2));


      if (imgCount < fileName.length)
			{
				img[imgCount] = new Image();
				img[imgCount].src=fileName[imgCount];
				img[imgCount].onload=loadImage;
				imgCount++;
			}
      else{
        runTrial();
      }
		}

    random_img = []
    for (var g=0;g< fileName.length;g++) {
      random_img.push(g);
    }

    shuffle(random_img)


    //#######################################################//
    //----------------------TRIAL MATRIX---------------------//
    //#######################################################//

    function createTrialMatrix(){

      //Code that lets me print out the trial matrix to a file
      /*function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([JSON.stringify(content)], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }*/

      //----------------------Initial Variables---------------------//
      miniblock_final = []
      miniblock_type_final = []
      miniblock_trials_final = []
      picture_final = []
      category_final = []
      category_switch_final = []
      action_final = []
      action_switch_final = []
      prev_switch_final = []
      correct_answer_final = []

      //----------------------MiniBlock Loop---------------------//
      //This should create enough miniblocks to fit the given blocklength
      for (var j = 0; j < numberoftrials/miniblocklength; j++){

          //----------------------Prime 1-------------------//
          //-----------------------------------------------//
          picture = [random_img[0+(j*4)],
          random_img[1+(j*4)],
          random_img[2+(j*4)],
          random_img[3+(j*4)]]

          //----------------------Category---------------------//
          category_balence = 0
          while (category_balence == 0){
            category = []
            for (var g=0;g<4;g++){
              category.push(math.randomInt(0,2))
            }
            shuffle(category)

            category_switch = []
            for (var g=0;g<4;g++){
              if(g == 0){category_switch.push(2)}
              else{
                if(category[g] != category[g-1]){
                  category_switch.push(0) //switch
                }
                if(category[g] == category[g-1]){
                  category_switch.push(1) //repeat
                }
              }
            }

            if(math.sum(category_switch) != 2 && math.sum(category_switch) != 5){
              category_balence = 1
            }
          };

          //----------------------Action---------------------//
          action_balence = 0
          while (action_balence == 0){

            action = []
            for (var g=0;g<4;g++){
              action.push(math.randomInt(0,2))
            }
            shuffle(action)

            action_switch = []
            correct_answer = []
            for (var g = 0; g < 4; g++){
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mannon[picture[g]] == 1){
                  correct_answer.push(48)
                }
            };

            for (var g=0;g<4;g++){
              if(g == 0){action_switch.push(2)}
              else{
                if(correct_answer[g] != correct_answer[g-1]){
                  action_switch.push(0) //switch
                }
                if(correct_answer[g] == correct_answer[g-1]){
                  action_switch.push(1) //repeat
                }
              }
            }

            if(math.sum(action_switch) != 2 && math.sum(action_switch) != 5  &&
          math.sum(correct_answer) != 192 && math.sum(correct_answer) != 196){
              action_balence = 1
            }
        };

          //----------------------Probe---------------------//
          //------------------------------------------------//
          //This while loop allows us to randomize the presentation
          //order while keeping certain requirements strict, such
          //as the action switch/repeat
          probe_pic_order = 0
          while(probe_pic_order == 0){
            picture_probe = [random_img[0+(j*4)],
            random_img[1+(j*4)],
            random_img[2+(j*4)],
            random_img[3+(j*4)]]
            shuffle(picture_probe)

            category_probe = [category[picture.indexOf(picture_probe[0])],
                              category[picture.indexOf(picture_probe[1])],
                              category[picture.indexOf(picture_probe[2])],
                              category[picture.indexOf(picture_probe[3])]]

            action_probe = [action[picture.indexOf(picture_probe[0])],
                            action[picture.indexOf(picture_probe[1])],
                            action[picture.indexOf(picture_probe[2])],
                            action[picture.indexOf(picture_probe[3])]]

            category_probe[picture_probe.indexOf(picture[0])] = math.randomInt(0,2)
            action_probe[picture_probe.indexOf(picture[0])] = math.randomInt(0,2)

            category_switch_probe = []
            for (var g=0;g<4;g++){
              if(g == 0){
                if(category[3] != category_probe[0]){
                  category_switch_probe.push(0) //switch
                }
                if(category[3] == category_probe[0]){
                  category_switch_probe.push(1) //repeat
                }
              }
              else{
                if(category_probe[g] != category_probe[g-1]){
                  category_switch_probe.push(0) //switch
                }
                if(category_probe[g] == category_probe[g-1]){
                  category_switch_probe.push(1) //repeat
                }
              }
            }

            action_switch_probe = []
            correct_answer_probe = []
            for (var g = 0; g < 4; g++){
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mannon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
            };

            for (var g=0;g<4;g++){
              if(g == 0){
                if(correct_answer[3] != correct_answer_probe[0]){
                  action_switch_probe.push(0) //switch
                }
                if(correct_answer[3] == correct_answer_probe[0]){
                  action_switch_probe.push(1) //repeat
                }
              }
              else{
                if(correct_answer_probe[g] != correct_answer_probe[g-1]){
                  action_switch_probe.push(0) //switch
                }
                if(correct_answer_probe[g] == correct_answer_probe[g-1]){
                  action_switch_probe.push(1) //repeat
                }
              }
            }

            //checking whether there are enough switch/repeats between prime and probe
            primecatcheck = [0,0,0]
            if(category_switch_probe[picture_probe.indexOf(random_img[1+(j*4)])] == category_switch[picture.indexOf(random_img[1+(j*4)])]){
              primecatcheck[0] = 1
            }
            if(category_switch_probe[picture_probe.indexOf(random_img[2+(j*4)])] == category_switch[picture.indexOf(random_img[2+(j*4)])]){
              primecatcheck[1] = 1
            }
            if(category_switch_probe[picture_probe.indexOf(random_img[3+(j*4)])] == category_switch[picture.indexOf(random_img[3+(j*4)])]){
              primecatcheck[2] = 1
            }

            if(picture_probe[0] != picture[3] &&
              action_switch_probe[picture_probe.indexOf(random_img[1+(j*4)])] == action_switch[picture.indexOf(random_img[1+(j*4)])] &&
              action_switch_probe[picture_probe.indexOf(random_img[2+(j*4)])] == action_switch[picture.indexOf(random_img[2+(j*4)])] &&
              action_switch_probe[picture_probe.indexOf(random_img[3+(j*4)])] == action_switch[picture.indexOf(random_img[3+(j*4)])] &&
              math.sum(primecatcheck) < 3){
                probe_pic_order = 1
              }
          };

          dummy_switch = [2,2,2,2]
          prev_switch = []
          prev_switch[picture_probe.indexOf(random_img[1+(j*4)])] = category_switch[picture.indexOf(random_img[1+(j*4)])]
          prev_switch[picture_probe.indexOf(random_img[2+(j*4)])] = category_switch[picture.indexOf(random_img[2+(j*4)])]
          prev_switch[picture_probe.indexOf(random_img[3+(j*4)])] = category_switch[picture.indexOf(random_img[3+(j*4)])]
          prev_switch[picture_probe.indexOf(random_img[0+(j*4)])] = 2

          miniblock = [j,j,j,j,j,j,j,j]
          miniblock_type = [0,0,0,0,1,1,1,1]
          miniblock_trials = [0,1,2,3,4,5,6,7]

          miniblock_final = miniblock_final.concat(miniblock)
          miniblock_type_final = miniblock_type_final.concat(miniblock_type)
          miniblock_trials_final = miniblock_trials_final.concat(miniblock_trials)
          picture_final = picture_final.concat(picture.concat(picture_probe))
          category_final = category_final.concat(category.concat(category_probe))
          category_switch_final = category_switch_final.concat(category_switch.concat(category_switch_probe))
          action_final = action_final.concat(action.concat(action_probe))
          action_switch_final = action_switch_final.concat(action_switch.concat(action_switch_probe))
          prev_switch_final = prev_switch_final.concat(dummy_switch.concat(prev_switch))
          correct_answer_final = correct_answer_final.concat(correct_answer.concat(correct_answer_probe))

      };

      trialmatrix = [miniblock_final,miniblock_type_final,miniblock_trials_final,
                    picture_final,category_final,category_switch_final,action_final,
                    action_switch_final,prev_switch_final,correct_answer_final]

      //Code that prints out the trial matrix to a file
      //download(trialmatrix, 'json.txt', 'text/plain');

    };

    //#######################################################//
    //--------MIND WANDERING PROBE LIST---------------------//
    //#######################################################//
    mwprobelist = []
    primeproberandomizer = [0,1]
    for (var g=1;g<5;g++){
      mwprobelist.push(g*6)
    };

    //#######################################################//
    //------------------INITIALIZING VARIABLES---------------//
    //#######################################################//
    i=0;
    primeprobe = 0;
    acccount = 0;
    acctotalcount = 0;
    notfullscreen = 0;
    instructionson = 0;
    miniblockon = 0;
    trialcount = 0;
    var totalcount = 0;
    var instructioncount = 0;
    stimscreencount = 0;

    //variables that just need to be
    type = 0;
    jokes = 0;

    //logfile
    var data=[['']];
    var runStart;
    var logCounter = 0;
    var onset;
    var d1;
    var checkResponse = false;
    var timeoutHandle = null;

    //#######################################################//
    //------------------EXPERIMENT SCREENS-------------------//
    //#######################################################//

    //---------------------CUE SCREENS----------------------//
    function image_screen(task, config, object){
      d1 = new Date();
      onset = d1.getTime() - runStart;
      type = 1;
      acc = 99;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 70px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws task cue based on:
      //trial matrix specifying the task (large vs. small; mechanical vs. non)
      //trial matrix specifying the configuration (which response configuration)
      //task: 0 = large vs small, 1 = mechanical vs non
      //config: 0 = L+S, M+N; 1 = S+L, N+M
      switch(task){
        case 0:
        switch(config) {
          case 0:
          ctx.fillText("L",myCanvas.width/2-300,myCanvas.height/2);
          ctx.fillText("S",myCanvas.width/2+300,myCanvas.height/2);
          break;

          case 1:
          ctx.fillText("S",myCanvas.width/2-300,myCanvas.height/2);
          ctx.fillText("L",myCanvas.width/2+300,myCanvas.height/2);
          break;
        };
        break;

        case 1:
        switch(config) {
          case 0:
          ctx.fillText("M",myCanvas.width/2-300,myCanvas.height/2);
          ctx.fillText("N",myCanvas.width/2+300,myCanvas.height/2);
          break;

          case 1:
          ctx.fillText("N",myCanvas.width/2-300,myCanvas.height/2);
          ctx.fillText("M",myCanvas.width/2+300,myCanvas.height/2);
          break;
        };
        break;
      };

      //record presentation data
      data[logCounter] = ["SP:", i, onset, object, 9999, 9999,
      trialmatrix[0][i],trialmatrix[1][i],trialmatrix[2][i],trialmatrix[3][i],
      trialmatrix[4][i],trialmatrix[5][i],trialmatrix[6][i],trialmatrix[7][i],
      trialmatrix[8][i],trialmatrix[9][i]];
      logCounter++;

      //draw image
      ctx.drawImage(img[object], myCanvas.width/2-(256/2), myCanvas.height/2-(256/2));

      //timeout variable
      timeoutIMAGE = setTimeout(iti_screen,IMAGEinterval);
    };

    //--------------------RECORD NO RESPONSE----------------//
    function record_noresponse(){
      data[logCounter] = ["SR:", i, 9999, 9999, 9999, 9999,
      trialmatrix[0][i],trialmatrix[1][i],trialmatrix[2][i],trialmatrix[3][i],
      trialmatrix[4][i],trialmatrix[5][i],trialmatrix[6][i],trialmatrix[7][i],
      trialmatrix[8][i],trialmatrix[9][i]];
      logCounter++;
      iti_screen();
    }

    //-----------------------ITI SCREENS-------------------//
    function iti_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //determines which feedback to give
      if (acc == 1) {
        ctx.fillStyle="green";
        ctx.fillText("Correct",myCanvas.width/2,(myCanvas.height/2));
      }
      else if (acc == 0) {
        ctx.fillStyle="red";
        ctx.fillText("Incorrect",myCanvas.width/2,(myCanvas.height/2));
      }
      else if (acc == 99) {
        ctx.fillStyle="white";
        ctx.fillText("Too Slow",myCanvas.width/2,(myCanvas.height/2));
      }

      //timeout variable
      stimscreencount++;
      timeoutITI = setTimeout(isi_screen,ITIinterval);
    };

    function iti_MW(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws fixation point
      ctx.fillText("*",myCanvas.width/2,(myCanvas.height/2));
      timeoutITI = setTimeout(runTrial,ITIinterval);
    };

    //-----------------------ISI SCREENS-------------------//
    function isi_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws fixation point
      ctx.fillText("*",myCanvas.width/2,(myCanvas.height/2));

      //timeout variable
      timeoutISI = setTimeout(runTrial,ISIinterval);
    };

    //-------------------COUNTDOWN SCREENS----------------//
    function countDown(time){
      type = 0;
      if (time > 0)
      {
        $("#startButton").hide();
        ctx.fillStyle = "white";
        ctx.font="60px Arial";
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.fillText(""+time, 450, 450);
        timeoutcountdown = setTimeout(function(){countDown(time-1)},750);
      }
      else
      {
        runTrial();
      }
    };

    //#######################################################//
    //-----------------INSTRUCTION SCREENS-------------------//
    //#######################################################//
    function instructions(){
      type = 3;
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      ctx.font="bold 45px Arial";
      ctx.fillText("This is a practice task.", (myCanvas.width/2), (myCanvas.height/2)-400);
      ctx.font="25px Arial";
      ctx.fillText("This task will take ~2min in total.", (myCanvas.width/2), (myCanvas.height/2)-350);
      ctx.fillText("You can repeat this practice task as many times as needed before", (myCanvas.width/2), (myCanvas.height/2)-300);
      ctx.fillText("you complete the real task, however, this practice is not compensated.", (myCanvas.width/2), (myCanvas.height/2)-270);
      ctx.fillText("__________________________________________________________________________________", (myCanvas.width/2), (myCanvas.height/2)-230);
      ctx.textAlign="left";
      ctx.fillText("On each trial you will be presented with two letters on either side of a picture", 0, (myCanvas.height/2)-200);
      ctx.fillText("that will indicate what characteristics you will be using to judge the picture on", (0.0), (myCanvas.height/2)-170);
      ctx.fillText("and which button you will press to indicate your response.", (0.0), (myCanvas.height/2)-140);

      ctx.fillText("   -- M/N indicates mechanical (M) or non-mechanical (N).", (0.0), (myCanvas.height/2)-105);
      ctx.fillText("   -- L/S indicates large (L) or small (S).", (0.0), (myCanvas.height/2)-75);

      ctx.fillText("The order of the letters indicates the correct response key for each option.", (0.0), (myCanvas.height/2)-10);
      ctx.fillText("    -- The letter to the left of the picture indicates you should", (0.0), (myCanvas.height/2)+20);
      ctx.fillText("          press the '1' key (NOT using the numpad) to select that response.", 0, (myCanvas.height/2)+50);
      ctx.fillText("    -- The letter to the right of the picture indicates you should", 0, (myCanvas.height/2)+80);
      ctx.fillText("          press the '0' key (NOT using the numpad) to select that response.", 0, (myCanvas.height/2)+110);

      ctx.fillText("Intermittently, you will be asked whether you were focused on the task.", (0.0), (myCanvas.height/2)+175);
      ctx.fillText("There is NO right answer to this question, and your answer will not", (0.0), (myCanvas.height/2)+205);
      ctx.fillText("affect your accuracy or eventual compensation. Please respond truthfully", (0.0), (myCanvas.height/2)+235);
      ctx.fillText("to the onscreen options when this happens.", (0.0), (myCanvas.height/2)+265);

      ctx.textAlign="center";
      ctx.fillText("Press any button to begin the task.", (myCanvas.width/2), (myCanvas.height/2)+420);
    };

    //#######################################################//
    //----------------MIND WANDERING PROBE-------------------//
    //#######################################################//

    function mindwanderingprobe(){
      type = 4;
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      ctx.fillText("Just prior to the onset of this screen, I was:", (myCanvas.width/2), (myCanvas.height/2)-50);
      ctx.fillText("(5) Focused on the task.", (myCanvas.width/2), (myCanvas.height/2));
      ctx.fillText("(6) Not focused on the task, but I WAS trying to focus on it.", (myCanvas.width/2), (myCanvas.height/2)+50);
      ctx.fillText("(7) Not focused on the task, and I WASN'T trying to focus on it.", (myCanvas.width/2), (myCanvas.height/2)+100);

      ctx.fillText("Please press the corresponding number to indiciate your choice.", (myCanvas.width/2), (myCanvas.height/2)+200);

      if(i % 8 === 0){
        primeprobe = 1
      }
      else {primeprobe = 0}

      //record presentation data
      data[logCounter] = ["MWP:", i, onset, object, 9999, primeprobe,
      trialmatrix[0][i],trialmatrix[1][i],trialmatrix[2][i],trialmatrix[3][i],
      trialmatrix[4][i],trialmatrix[5][i],trialmatrix[6][i],trialmatrix[7][i],
      trialmatrix[8][i],trialmatrix[9][i]];
      logCounter++;
    };

    //#######################################################//
    //-----------------------ERROR SCREENS-------------------//
    //#######################################################//

    //-----------------------NOT FULL SCREEN----------------//
    function nonfullscreen(){
      type = 2;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="bold 30px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      if (notfullscreen == 0){
        ctx.fillText("Your screen is not full screen.",myCanvas.width/2,myCanvas.height/2);
        ctx.fillText("Please correct this and press any key to continue.",myCanvas.width/2,(myCanvas.height/2)+50);
        ctx.fillText("If you exit full screen one more time during this experiment,",myCanvas.width/2,(myCanvas.height/2)+100);
        ctx.fillText("you will have to restart the experiment and will not be paid",myCanvas.width/2,(myCanvas.height/2)+150);
        ctx.fillText("for the previous time you have spent doing the experiment.",myCanvas.width/2,(myCanvas.height/2)+200);
        notfullscreen++;
      }
      else {ctx.fillText("Please refresh the page to restart the experiment.",myCanvas.width/2,myCanvas.height/2);
      notfullscreen++;
      }
    };

    //-----------------------CHECKS SIZE SCREEN----------------//
    function checkSize(){
      var w = window.innerWidth;
      var h = window.innerHeight;
      if (w < 800 || h < 600) // 800 by 600 is the lowest resolution on my laptop; seems like a good "minimum" (basically need 500 x 500 at least)
      {
        checkwindowsize = 1;
      }
      else // if their screen is the proper size...
      {
        checkwindowsize = 0;
      }
    };

    //#######################################################//
    //-----------------------RUN EXPERIMENT------------------//
    //#######################################################//
    function runTrial(){
        if (trialcount < numberoftrials){
          if (trialcount+instructionson == 0) {
            instructionson = 1; i = 0; createTrialMatrix(); instructions();}

          else if (mwprobelist.includes(i) && mindwanderon == 0){
            mindwanderon = 1; mindwanderingprobe();}

          //Present the Cue and Object
          else if (stimscreencount == 0){checkSize();
            if (checkwindowsize == 0) {image_screen(trialmatrix[4][i],trialmatrix[6][i],trialmatrix[3][i]);}
            else if (checkwindowsize == 1) {nonfullscreen();}}

          else if (stimscreencount == 1){
            stimscreencount = 0; i++; trialcount++; acctotalcount++; mindwanderon = 0; instructionson = 0;
            runTrial();}
          }
          else{
            //alert(data.join(";"));
            $("#info").css("color","white");
            //$("#info").show();
            $("#info").text(data.join(";"));
            //$("#mturk_form").show();
            $("#RTs", opener.window.document).val(data.join(";"));
            opener.updateMainMenu(3);
            JavaScript:window.close();
          }
        };


        //Detect events likes clicks or button presses
        $("body").keypress(function(event){
          //clearTimeout();
          if (type == 1 || type == 2 || type == 3 || type == 4) {key = event.keyCode || event.which};
          //creates more data
          d1 = new Date();
          Ronset = d1.getTime()-runStart;
          respTime = Ronset-onset;
          acc = 0;
          if (type == 0) {jokes++;}
          else if (type == 1) {
            if(key == 48 && trialmatrix[9][i] == 48){
              acc = 1; acccount++;
            }
            if(key == 49 && trialmatrix[9][i] == 49){
              acc = 1; acccount++;
            }
          }
          else if (type == 2) {checkSize(); if (checkwindowsize == 0 && notfullscreen == 1) {countDown(3);} else {jokes++;}}
          else if (type == 3) {instructioncount++; document.getElementById("myCanvas").style.cursor = "none"; countDown(3);}
          else if (type == 4) {acc = 1}
        });

        $("body").keyup(function(event){
          //clearTimeout();
          if (type == 1 || type == 2 || type == 3 || type == 4) {key = event.keyCode || event.which};
          //creates more data
          if (type == 1) {
            data[logCounter] = ["SR:", i, Ronset, key, respTime, acc,
            trialmatrix[0][i],trialmatrix[1][i],trialmatrix[2][i],trialmatrix[3][i],
            trialmatrix[4][i],trialmatrix[5][i],trialmatrix[6][i],trialmatrix[7][i],
            trialmatrix[8][i],trialmatrix[9][i]];
            logCounter++;
          }
          if (type == 4) {
            if(key == 53 || key == 54 || key == 55){
              data[logCounter] = ["MWR:", i, Ronset, key, respTime, primeprobe,
              trialmatrix[0][i],trialmatrix[1][i],trialmatrix[2][i],trialmatrix[3][i],
              trialmatrix[4][i],trialmatrix[5][i],trialmatrix[6][i],trialmatrix[7][i],
              trialmatrix[8][i],trialmatrix[9][i]];
              logCounter++; iti_MW();
            }
          }
          else {jokes++;}
        });

        //Start stuff
        $("#info").hide();
        $("#form").hide();
        $('#button').hide();
        $("#mturk_form").hide();
        d1 = new Date();
        runStart = d1.getTime();
        loadImage();

      });

      </script>
    </head>
    <body>
      <table>
        <tr>
          <td>
            <canvas id="myCanvas" width="900" height="900"> </canvas>
            <div style="text-align:center; align:center;">
            </div>
            <div style="text-align:center;">
              <button id="startButton">Start</button>
            </div>
            <div style="text-align:center;">
              <button id="button">NEXT</button>
            </div>
            <form id="form" onsubmit="return false;">
              <input   style=position:absolute;top:80%;left:40%;width:10%; type="text" id="userInput">
            </form>
            <form id="mturk_form" method="POST" action="https://dibs-web01.vm.duke.edu/AMTSubmit/dataHandler.php">
              <!-- <form id="mturk_form" method="POST" action="https://workersandbox.mturk.com/mturk/externalSubmit"> -->
              <!-- <form id="mturk_form" method="POST" action="https://wwww.mturk.com/mturk/externalSubmit"> -->
              <input type="hidden" id="assignmentId" name="assignmentId" value="">
              <input type="hidden" id="workerId" name="workerId" value="">
              <input type="hidden" id="hitId" name="hitId" value="">
              <input type="hidden" id="RTs" name="RTs" value="">
              <input type="hidden" id="demographics" name="demographics" value="SCSAswitch_MW_2_replication">
              <input type="hidden" id="ExpName" name="ExpName" value="SCSAswitch_MW_2_replication">
            </form>
          </td>
        </tr>
      </table>
    </body>
    </html>
