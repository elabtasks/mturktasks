<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="Task.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="jquery-3.2.1.js"></script>
  <script type="text/javascript" src="math.js"></script>
  <script type="text/javascript" src="image_prac.js"></script>
  <script type="text/javascript">


  $(document).ready(function(){
    $("#form").hide();
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    document.getElementById("myCanvas").style.cursor = "none";

    //#######################################################//
    //-------------GLOBAL EXPERIMENT PARAMETERS--------------//
    //#######################################################//

    //------------------------TIMINGS-----------------------//
    var CUEinterval = 700
    var OBJECTinterval = 2000
    var ITIinterval = 500
    var ISIinterval = 500

    //---------------------TRIAL COUNTS--------------------//
    var numberofblocks = 1;
    var blocklength = 32;

    //----------------------SHUFFLE FUNCTION------------------//
    //https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;
      // While there remain elements to shuffle...
      while (0 !== currentIndex) {
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    };

    //#######################################################//
    //-----------------------LOAD IMAGES---------------------//
    //#######################################################//

    var fileName = listimagenames
		 img = new Array(fileName.length);
		var imgCount = 0;

		function loadImage()
    {
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      ctx.font="bold 45px Arial";
      ctx.fillText("The task is loading. Please wait.", (myCanvas.width/2), (myCanvas.height/2)-400);
      ctx.fillText((imgCount/fileName.length)*100+"%", (myCanvas.width/2), (myCanvas.height/2));


      if (imgCount < fileName.length)
			{
				img[imgCount] = new Image();
				img[imgCount].src=fileName[imgCount];
				img[imgCount].onload=loadImage;
				imgCount++;
			}
      else{
        runTrial();
      }
		}

    random_img = []
    for (var g=0;g< fileName.length;g++) {
      random_img.push(g);
    }

    shuffle(random_img)


    //#######################################################//
    //----------------------TRIAL MATRIX---------------------//
    //#######################################################//

    function createTrialMatrix(picorder){

      //Code that lets me print out the trial matrix to a file
      /*function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([JSON.stringify(content)], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }*/

      //----------------------Initial Variables---------------------//
      miniblock_final = []
      miniblock_type_final = []
      miniblock_trials_final = []
      picture_final = []
      category_final = []
      category_switch_final = []
      action_final = []
      action_switch_final = []
      prev_switch_final = []
      correct_answer_final = []

      //----------------------MiniBlock Loop---------------------//
      //This should create enough miniblocks to fit the given blocklength
      for (var j = 0; j < blocklength/8; j++){

          //----------------------Prime---------------------//
          //-----------------------------------------------//
          picture = [random_img[0+(j*4+(picorder*blocklength))],random_img[1+(j*4+(picorder*blocklength))],
          random_img[2+(j*4+(picorder*blocklength))],random_img[3+(j*4+(picorder*blocklength))]]

          //----------------------Category---------------------//
          category_balence = 0
          while (category_balence == 0){
            category = []
            for (var g=0;g<4;g++){
              category.push(Math.round(Math.random()))
            }
            shuffle(category)

            category_switch = []
            for (var g=0;g<4;g++){
              if(g == 0){category_switch.push(2)}
              else{
                if(category[g] != category[g-1]){
                  category_switch.push(0) //switch
                }
                if(category[g] == category[g-1]){
                  category_switch.push(1) //repeat
                }
              }
            }

            if(math.sum(category_switch) != 2 && math.sum(category_switch) != 5){
              category_balence = 1
            }
          };

          //----------------------Action---------------------//
          action_balence = 0
          while (action_balence == 0){

            action = []
            for (var g=0;g<4;g++){
              action.push(Math.round(Math.random()))
            }
            shuffle(action)

            action_switch = []
            correct_answer = []
            for (var g = 0; g < 4; g++){
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 0){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 0 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 0 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 0 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(48)
                }
              if (category[g] == 1 && action[g] == 0 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(49)
                }
              if (category[g] == 1 && action[g] == 1 &&
                correct_largesmall[picture[g]] == 1 &&
                correct_mechnon[picture[g]] == 1){
                  correct_answer.push(48)
                }
            };

            for (var g=0;g<4;g++){
              if(g == 0){action_switch.push(2)}
              else{
                if(correct_answer[g] != correct_answer[g-1]){
                  action_switch.push(0) //switch
                }
                if(correct_answer[g] == correct_answer[g-1]){
                  action_switch.push(1) //repeat
                }
              }
            }

            if(math.sum(action_switch) != 2 && math.sum(action_switch) != 5 &&
          math.sum(correct_answer) != 192 && math.sum(correct_answer) != 196){
              action_balence = 1
            }
        };

          //----------------------Probe---------------------//
          //This while loop allows us to randomize the presentation
          //order while keeping certain requirements strict, such
          //as the action switch/repeat
          probe_pic_order = 0
          while(probe_pic_order == 0){
            picture_probe = [random_img[0+(j*4+(picorder*blocklength))],random_img[1+(j*4+(picorder*blocklength))],
            random_img[2+(j*4+(picorder*blocklength))],random_img[3+(j*4+(picorder*blocklength))]]
            shuffle(picture_probe)

            category_probe = [category[picture.indexOf(picture_probe[0])],
                              category[picture.indexOf(picture_probe[1])],
                              category[picture.indexOf(picture_probe[2])],
                              category[picture.indexOf(picture_probe[3])]]

            action_probe = [action[picture.indexOf(picture_probe[0])],
                            action[picture.indexOf(picture_probe[1])],
                            action[picture.indexOf(picture_probe[2])],
                            action[picture.indexOf(picture_probe[3])]]

            category_probe[picture_probe.indexOf(picture[0])] = Math.round(Math.random())
            action_probe[picture_probe.indexOf(picture[0])] = Math.round(Math.random())

            category_switch_probe = []
            for (var g=0;g<4;g++){
              if(g == 0){
                if(category[3] != category_probe[0]){
                  category_switch_probe.push(0) //switch
                }
                if(category[3] == category_probe[0]){
                  category_switch_probe.push(1) //repeat
                }
              }
              else{
                if(category_probe[g] != category_probe[g-1]){
                  category_switch_probe.push(0) //switch
                }
                if(category_probe[g] == category_probe[g-1]){
                  category_switch_probe.push(1) //repeat
                }
              }
            }

            action_switch_probe = []
            correct_answer_probe = []
            for (var g = 0; g < 4; g++){
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 0){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 0 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 0 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 0 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
              if (category_probe[g] == 1 && action_probe[g] == 0 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(49)
                }
              if (category_probe[g] == 1 && action_probe[g] == 1 &&
                correct_largesmall[picture_probe[g]] == 1 &&
                correct_mechnon[picture_probe[g]] == 1){
                  correct_answer_probe.push(48)
                }
            };

            for (var g=0;g<4;g++){
              if(g == 0){
                if(correct_answer[3] != correct_answer_probe[0]){
                  action_switch_probe.push(0) //switch
                }
                if(correct_answer[3] == correct_answer_probe[0]){
                  action_switch_probe.push(1) //repeat
                }
              }
              else{
                if(correct_answer_probe[g] != correct_answer_probe[g-1]){
                  action_switch_probe.push(0) //switch
                }
                if(correct_answer_probe[g] == correct_answer_probe[g-1]){
                  action_switch_probe.push(1) //repeat
                }
              }
            }

            //checking whether there are enough switch/repeats between prime and probe
            primecatcheck = [0,0,0]
            if(category_switch_probe[picture_probe.indexOf(random_img[1+(j*4+(picorder*blocklength))])] ==  category_switch[picture.indexOf(random_img[1+(j*4+(picorder*blocklength))])]){
              primecatcheck[0] = 1
            }
            if(category_switch_probe[picture_probe.indexOf(random_img[2+(j*4+(picorder*blocklength))])] ==  category_switch[picture.indexOf(random_img[2+(j*4+(picorder*blocklength))])]){
              primecatcheck[1] = 1
            }
            if(category_switch_probe[picture_probe.indexOf(random_img[3+(j*4+(picorder*blocklength))])] ==  category_switch[picture.indexOf(random_img[3+(j*4+(picorder*blocklength))])]){
              primecatcheck[2] = 1
            }

            if(picture_probe[0] != picture[3] &&
              action_switch_probe[picture_probe.indexOf(random_img[1+(j*4+(picorder*blocklength))])] ==  action_switch[picture.indexOf(random_img[1+(j*4+(picorder*blocklength))])] &&
              action_switch_probe[picture_probe.indexOf(random_img[2+(j*4+(picorder*blocklength))])] ==  action_switch[picture.indexOf(random_img[2+(j*4+(picorder*blocklength))])] &&
              action_switch_probe[picture_probe.indexOf(random_img[3+(j*4+(picorder*blocklength))])] ==  action_switch[picture.indexOf(random_img[3+(j*4+(picorder*blocklength))])] &&
              math.sum(primecatcheck) != 3 && math.sum(primecatcheck) != 0){
                probe_pic_order = 1
              }
          };

          dummy_switch = [2,2,2,2]
          prev_switch = []
          prev_switch[picture_probe.indexOf(random_img[1+(j*4+(picorder*blocklength))])] = category_switch[picture.indexOf(random_img[1+(j*4+(picorder*blocklength))])]
          prev_switch[picture_probe.indexOf(random_img[2+(j*4+(picorder*blocklength))])] = category_switch[picture.indexOf(random_img[2+(j*4+(picorder*blocklength))])]
          prev_switch[picture_probe.indexOf(random_img[3+(j*4+(picorder*blocklength))])] = category_switch[picture.indexOf(random_img[3+(j*4+(picorder*blocklength))])]
          prev_switch[picture_probe.indexOf(random_img[0+(j*4+(picorder*blocklength))])] = 2

          miniblock = [j,j,j,j,j,j,j,j]
          miniblock_type = [0,0,0,0,1,1,1,1]
          miniblock_trials = [0,1,2,3,4,5,6,7]

          miniblock_final = miniblock_final.concat(miniblock)
          miniblock_type_final = miniblock_type_final.concat(miniblock_type)
          miniblock_trials_final = miniblock_trials_final.concat(miniblock_trials)
          picture_final = picture_final.concat(picture.concat(picture_probe))
          category_final = category_final.concat(category.concat(category_probe))
          category_switch_final = category_switch_final.concat(category_switch.concat(category_switch_probe))
          action_final = action_final.concat(action.concat(action_probe))
          action_switch_final = action_switch_final.concat(action_switch.concat(action_switch_probe))
          prev_switch_final = prev_switch_final.concat(dummy_switch.concat(prev_switch))
          correct_answer_final = correct_answer_final.concat(correct_answer.concat(correct_answer_probe))

      };

      trialmatrix = [miniblock_final,miniblock_type_final,miniblock_trials_final,
                    picture_final,category_final,category_switch_final,action_final,
                    action_switch_final,prev_switch_final,correct_answer_final]

      //Code that prints out the trial matrix to a file
      //download(trialmatrix, 'json.txt', 'text/plain');

    };



    //#######################################################//
    //------------------INITIALIZING VARIABLES---------------//
    //#######################################################//
    i=0;
    acccount = 0;
    acctotalcount = 0;
    notfullscreen = 0;
    instructionson = 0;
    miniblockon = 0;
    block = 0;
     trialcount = 0;
    var totalcount = 0;
    var instructioncount = 0;
     stimscreencount = 0;

    //variables that just need to be
    type = 0;
    jokes = 0;

    //logfile
    var data=[['']];
    var runStart;
    var logCounter = 0;
    var onset;
    var d1;
    var checkResponse = false;
    var timeoutHandle = null;

    //#######################################################//
    //------------------EXPERIMENT SCREENS-------------------//
    //#######################################################//

    //---------------------CUE SCREENS----------------------//
    function cue_screen(task, config){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws task cue based on:
      //trial matrix specifying the task (large vs. small; mechanical vs. non)
      //trial matrix specifying the configuration (which response configuration)
      //task: 0 = large vs small, 1 = mechanical vs non
      //config: 0 = L+S, M+N; 1 = S+L, N+M
      switch(task){
        case 0:
        switch(config) {
          case 0:
          ctx.fillText("L + S",myCanvas.width/2,myCanvas.height/2);
          break;

          case 1:
          ctx.fillText("S + L",myCanvas.width/2,myCanvas.height/2);
          break;
        };
        break;

        case 1:
        switch(config) {
          case 0:
          ctx.fillText("M + N",myCanvas.width/2,myCanvas.height/2);
          break;

          case 1:
          ctx.fillText("N + M",myCanvas.width/2,myCanvas.height/2);
          break;
        };
        break;
      };

      //timeout variable
      stimscreencount++;
      timeoutCUE = setTimeout(isi_screen,CUEinterval);
    };

    //---------------------OBJECT SCREENS-------------------//
    function object_screen(object){
      type = 1;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //draw image
      ctx.drawImage(img[object], myCanvas.width/2-128, myCanvas.height/2-128);

      //timeout variable
      timeoutOBJECT = setTimeout(iti_screen,OBJECTinterval);
    };

    //-----------------------ITI SCREENS-------------------//
    function iti_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //determines which feedback to give
      if (acc == 1) {
        ctx.fillText("Correct",myCanvas.width/2,(myCanvas.height/2));
      }
      else if (acc == 0) {
        ctx.fillText("Incorrect",myCanvas.width/2,(myCanvas.height/2));
      }

      //timeout variable
      stimscreencount++;
      timeoutITI = setTimeout(isi_screen,ITIinterval);
    };

    //-----------------------ISI SCREENS-------------------//
    function isi_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 50px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws fixation point
      ctx.fillText("*",myCanvas.width/2,(myCanvas.height/2));

      //timeout variable
      timeoutISI = setTimeout(runTrial,ISIinterval);
    };

    //-------------------COUNTDOWN SCREENS----------------//
    function countDown(time){
      type = 0;
      if (time > 0)
      {
        $("#startButton").hide();
        ctx.fillStyle = "white";
        ctx.font="60px Arial";
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.fillText(""+time, 450, 450);
        timeoutcountdown = setTimeout(function(){countDown(time-1)},1000);
      }
      else
      {
        runTrial();
      }
    };

    //#######################################################//
    //-----------------INSTRUCTION SCREENS-------------------//
    //#######################################################//
    function instructions(){
      type = 3;
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      if (instructioncount == 0){
        ctx.font="bold 45px Arial";
        ctx.fillText("You will now begin the task.", (myCanvas.width/2), (myCanvas.height/2)-400);
        ctx.font="25px Arial";
        ctx.fillText("You will complete "+numberofblocks+" blocks of trials, taking ~3min in total.", (myCanvas.width/2), (myCanvas.height/2)-350);
        ctx.fillText("At the end of each block, you will be told your current accuracy.", (myCanvas.width/2), (myCanvas.height/2)-300);
        ctx.fillText("Remember you need >75% accuracy in the task.", (myCanvas.width/2), (myCanvas.height/2)-250);
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-200);
        ctx.fillText("__________________________________________________________________________________", (myCanvas.width/2), (myCanvas.height/2)-180);
        ctx.textAlign="left";
        ctx.fillText("At the beginning of each trial, you will be presented with two letters that will", 0, (myCanvas.height/2)-150);
        ctx.fillText("indicate what characteristics you will be using to judge the following picture and", (0.0), (myCanvas.height/2)-100);
        ctx.fillText("which button you will press to indicate your response.", (0.0), (myCanvas.height/2)-50);


        ctx.fillText("   -- M/N indicates mechanical (M) or non-mechanical (N).", (0.0), (myCanvas.height/2)-0);
        ctx.fillText("   -- L/S indicates large (L) or small (S).", (0.0), (myCanvas.height/2)+50);

        ctx.fillText("The order of the letters indicates the correct response key for each option.", (0.0), (myCanvas.height/2)+130);
        ctx.fillText("    -- The letter on the left indicates you should press the '1' key", (0.0), (myCanvas.height/2)+180);
        ctx.fillText("          (NOT using the numpad) to indicate that response.", 0, (myCanvas.height/2)+230);
        ctx.fillText("    -- The letter on the right indicates you should press the '0' key", 0, (myCanvas.height/2)+280);
        ctx.fillText("          (NOT using the numpad) to indicate that response.", 0, (myCanvas.height/2)+330);

        ctx.textAlign="center";
        ctx.fillText("Press any button to begin the task.", (myCanvas.width/2), (myCanvas.height/2)+420);
      }

      if (instructioncount > 0){
        ctx.fillText("This is a short break. Your accuracy is: " +Math.round((acccount/acctotalcount)*100)+" %", (myCanvas.width/2), (myCanvas.height/2)-400);
        ctx.fillText("You have completed " +(block+1)+" of "+ numberofblocks + " blocks.", (myCanvas.width/2), (myCanvas.height/2)-360);
        ctx.fillText("Remember you need >75% accuracy in the task.", (myCanvas.width/2), (myCanvas.height/2)-320);
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-200);
        ctx.fillText("__________________________________________________________________________________", (myCanvas.width/2), (myCanvas.height/2)-180);
        ctx.textAlign="left";
        ctx.fillText("At the beginning of each trial, you will be presented with two letters that will", 0, (myCanvas.height/2)-150);
        ctx.fillText("indicate what characteristics you will be using to judge the following picture and", (0.0), (myCanvas.height/2)-100);
        ctx.fillText("which button you will press to indicate your response.", (0.0), (myCanvas.height/2)-50);


        ctx.fillText("   -- M/N indicates mechanical (M) or non-mechanical (N).", (0.0), (myCanvas.height/2)-0);
        ctx.fillText("   -- L/S indicates large (L) or small (S).", (0.0), (myCanvas.height/2)+50);

        ctx.fillText("The order of the letters indicates the correct response key for each option.", (0.0), (myCanvas.height/2)+130);
        ctx.fillText("    -- The letter on the left indicates you should press the '1' key", (0.0), (myCanvas.height/2)+180);
        ctx.fillText("          (NOT using the numpad) to indicate that response.", 0, (myCanvas.height/2)+230);
        ctx.fillText("    -- The letter on the right indicates you should press the '0' key", 0, (myCanvas.height/2)+280);
        ctx.fillText("          (NOT using the numpad) to indicate that response.", 0, (myCanvas.height/2)+330);
        ctx.textAlign="center";
        ctx.fillText("Press any button to begin the task.", (myCanvas.width/2), (myCanvas.height/2)+420);
        block++;
      }
    };

    //#######################################################//
    //------------------MINIBLOCK SCREENS--------------------//
    //#######################################################//

    function miniblockscreen(){
      type = 3;
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      ctx.fillText("You are "+Math.round((i/blocklength)*100)+"% through this block.", (myCanvas.width/2), (myCanvas.height/2)-50);
      ctx.fillText("Your accuracy is "+Math.round((acccount/acctotalcount)*100)+"%.", (myCanvas.width/2), (myCanvas.height/2));
      ctx.fillText("Remember you need >75% accuracy to be paid.", (myCanvas.width/2), (myCanvas.height/2)+50);
      ctx.fillText("Press any key to continue.", (myCanvas.width/2), (myCanvas.height/2)+100);
    };

    //#######################################################//
    //-----------------------ERROR SCREENS-------------------//
    //#######################################################//

    //-----------------------NOT FULL SCREEN----------------//
    function nonfullscreen(){
      type = 2;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="bold 30px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      if (notfullscreen == 0){
        ctx.fillText("Your screen is not full screen.",myCanvas.width/2,myCanvas.height/2);
        ctx.fillText("Please correct this and press any key to continue.",myCanvas.width/2,(myCanvas.height/2)+50);
        ctx.fillText("If you exit full screen one more time during this experiment,",myCanvas.width/2,(myCanvas.height/2)+100);
        ctx.fillText("you will have to restart the experiment and will not be paid",myCanvas.width/2,(myCanvas.height/2)+150);
        ctx.fillText("for the previous time you have spent doing the experiment.",myCanvas.width/2,(myCanvas.height/2)+200);
        notfullscreen++;
      }
      else {ctx.fillText("Please refresh the page to restart the experiment.",myCanvas.width/2,myCanvas.height/2);
      notfullscreen++;
      }
    };

    //-----------------------CHECKS SIZE SCREEN----------------//
    function checkSize(){
      var w = window.innerWidth;
      var h = window.innerHeight;
      if (w < 800 || h < 600) // 800 by 600 is the lowest resolution on my laptop; seems like a good "minimum" (basically need 500 x 500 at least)
      {
        checkwindowsize = 1;
      }
      else // if their screen is the proper size...
      {
        checkwindowsize = 0;
      }
    };

    //#######################################################//
    //-----------------------RUN EXPERIMENT------------------//
    //#######################################################//
    function runTrial(){
        if (trialcount < blocklength*numberofblocks){
          if ((trialcount+instructionson == 0 || (trialcount+instructionson) % blocklength === 0)) {
            instructionson = 1; i = 0; createTrialMatrix(block); instructions();}

          else if (((trialcount+miniblockon) % 8 === 0) && trialcount != 0) {
            miniblockon = 1; miniblockscreen();}

            //Present the Cue
            else if (stimscreencount == 0){checkSize();
              if (checkwindowsize == 0) {cue_screen(trialmatrix[4][i],trialmatrix[6][i]);}
              else if (checkwindowsize == 1) {nonfullscreen();}}

            //Present the Object
            else if (stimscreencount == 1){checkSize();
              if (checkwindowsize == 0) {object_screen(trialmatrix[3][i])}
              else if (checkwindowsize == 1) {nonfullscreen();}}

            else if (stimscreencount == 2){
              stimscreencount = 0; i++; trialcount++; acctotalcount++; miniblockon = 0; instructionson = 0;
              runTrial();}
              }
          else if (trialcount == blocklength*numberofblocks){
            miniblockscreen(); trialcount++;
          }
            else {
              //alert(data.join(";"));
              $("#info").css("color","white");
              //$("#info").show();
              $("#info").text(data.join(";"));
              //$("#mturk_form").show();
              $("#RTs", opener.window.document).val(data.join(";"));
              opener.updateMainMenu(3);
              JavaScript:window.close();
            }
          };


        //Detect events likes clicks or button presses
        $("body").keypress(function(event){
          //clearTimeout();
          if (type == 1 || type == 2 || type == 3) {key = event.keyCode || event.charCode};
          //creates more data
          d1 = new Date();
          Ronset = d1.getTime()-runStart;
          respTime = Ronset-onset;
          acc = 0;
          if (type == 0) {jokes++;}
          else if (type == 1) {
            if(key == 48 && trialmatrix[9][i] == 48){
              acc = 1; acccount++;
            }
            if(key == 49 && trialmatrix[9][i] == 49){
              acc = 1; acccount++;
            }
          }
          else if (type == 2) {checkSize(); if (checkwindowsize == 0 && notfullscreen == 1) {countDown(3);} else {jokes++;}}
          else if (type == 3) {instructioncount++; document.getElementById("myCanvas").style.cursor = "none"; countDown(3);}
        });

        $("body").keyup(function(event){
          //clearTimeout();
          if (type == 1 || type == 2 || type == 3) {key = event.keyCode || event.charCode};
          //creates more data
          if (type == 1) {
            //data[logCounter] = ["SR:", block, i, blocktype[block], Ronset, key, respTime, acc,
            //trialtype[block][random[i]], probematch[random[i]], trialload[random[i]]];
            logCounter++; clearTimeout(timeoutOBJECT); iti_screen();
          }
          else {jokes++;}
        });

        //Start stuff
        $("#info").hide();
        $("#form").hide();
        $('#button').hide();
        $("#mturk_form").hide();
        d1 = new Date();
        runStart = d1.getTime();
        loadImage();

      });

      </script>
    </head>
    <body>
      <table>
        <tr>
          <td>
            <canvas id="myCanvas" width="900" height="900"> </canvas>
            <div style="text-align:center; align:center;">
            </div>
            <div style="text-align:center;">
              <button id="startButton">Start</button>
            </div>
            <div style="text-align:center;">
              <button id="button">NEXT</button>
            </div>
            <form id="form" onsubmit="return false;">
              <input   style=position:absolute;top:80%;left:40%;width:10%; type="text" id="userInput">
            </form>
            <form id="mturk_form" method="POST" action="http://152.3.33.14/AMTSubmit/dataHandler.php">
              <!-- <form id="mturk_form" method="POST" action="https://workersandbox.mturk.com/mturk/externalSubmit"> -->
              <!-- <form id="mturk_form" method="POST" action="https://wwww.mturk.com/mturk/externalSubmit"> -->
              <input type="hidden" id="assignmentId" name="assignmentId" value="">
              <input type="hidden" id="workerId" name="workerId" value="">
              <input type="hidden" id="hitId" name="hitId" value="">
              <input type="hidden" id="RTs" name="RTs" value="">
              <input type="hidden" id="demographics" name="demographics" value="SCSAswitch">
              <input type="hidden" id="ExpName" name="ExpName" value="multWM">
            </form>
          </td>
        </tr>
      </table>
    </body>
    </html>
