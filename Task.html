<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="Task.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="jquery-3.2.1.js"></script>
  <script type="text/javascript" src="math.js"></script>
  <script type="text/javascript" src="images.js"></script>
  <script type="text/javascript">


  $(document).ready(function(){
    $("#form").hide();
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    document.getElementById("myCanvas").style.cursor = "none";

    //#######################################################//
    //-------------GLOBAL EXPERIMENT PARAMETERS--------------//
    //#######################################################//

    //------------------------TIMINGS-----------------------//
    var ISIinterval       = 500
    var ITIinterval       = 500

    //---------------------TRIAL COUNTS--------------------//
    var numberofblocks    = 1;
    var numberminiblocks  = 64; //incrament of 4

    //---------------------STIMS BANK---------------------//
    //yellow, green, pink, blue, purple, brown, red


    //----------------------SHUFFLE FUNCTION---------------//
    //https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array

    function shuffle(array) {
      for (var i = array.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = array[i];
          array[i] = array[j];
          array[j] = temp;
      }
        return array;
      };

    //-----RANDOMIZER FOR FREE FORCED SEQUENCE-----------//
    freeforcedsequence = [0,1]
    shuffle(freeforcedsequence)

    //#######################################################//
    //-----------------------LOAD IMAGES---------------------//
    //#######################################################//

    var fileName = listimagenames
		var img = new Array(fileName.length);
		var imgCount = 0;

		function loadImage()
		{
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      ctx.font="bold 45px Arial";
      ctx.fillText("The task is loading. Please wait.", (myCanvas.width/2), (myCanvas.height/2)-400);
      ctx.fillText(Math.round((imgCount/fileName.length)*100)+"%", (myCanvas.width/2), (myCanvas.height/2));


      if (imgCount < fileName.length)
			{
				img[imgCount] = new Image();
				img[imgCount].src=fileName[imgCount];
				img[imgCount].onload=loadImage;
				imgCount++;
			}
      else{
        runTrial();
      }
		}

    random_img = []
    for (var g=0;g< fileName.length;g++) {
      random_img.push(g);
    }

    shuffle(random_img)

    //#######################################################//
    //----------------------TRIAL MATRIX---------------------//
    //#######################################################//

    function createTrialMatrix(block){

      //Code that lets me print out the trial matrix to a file
      /*function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([JSON.stringify(content)], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }*/

      //----------------------Initial Variables---------------------//
      blocktype         = []
      image1            = []
      image2            = []
      image3            = []
      image4            = []
      trial             = []
      order             = []
      stage             = []
      compatibility     = []

      //------------------------Miniblock length-------------------//
      miniblocklength = []
      for (var g=0;g<numberminiblocks;g++){
        if (g < (numberminiblocks/4)){
          miniblocklength.push(0)
        }
        if (g > (numberminiblocks/4)-1 && g < (numberminiblocks/4)*2){
          miniblocklength.push(1)
        }
        if (g > (((numberminiblocks/4)*2)-1) && g < (numberminiblocks/4)*3){
          miniblocklength.push(2)
        }
        if (g > (((numberminiblocks/4)*3)-1) && g < (numberminiblocks/4)*4){
          miniblocklength.push(3)
        }
      }
      shuffle(miniblocklength)

      //---------------------------Block Type----------------------//
      blocktype_iter = []
      for (var g=0;g<numberminiblocks;g++){
        if (g % 2 === 0){
          blocktype_iter.push(0)
        }
        else {
          blocktype_iter.push(1)
        }
      }
      shuffle(blocktype_iter)

      for (var g=0;g<numberminiblocks;g++){
        switch (miniblocklength[g]){
          case 0:
            stage.push(0,2,2)
            trial.push(0,0,1)
            goorder = [0,1]
            shuffle(goorder)
            order.push(0,goorder[0],goorder[1])
            compatibility.push(2,2,2)
            break;
          case 1:
            stage.push(0,1,2,2)
            trial.push(0,0,0,1)
            goorder = [0,1]
            nextorder = [0,1]
            compatorder = [0,1]
            shuffle(goorder)
            shuffle(nextorder)
            shuffle(compatorder)
            order.push(0,nextorder[0],nextorder[0],goorder[1])
            compatibility.push(2,compatorder[0],2,2)
            break;
          case 2:
            stage.push(0,1,1,2,2)
            trial.push(0,0,1,0,1)
            goorder = [0,1]
            nextorder = [0,1]
            compatorder = [0,1]
            shuffle(goorder)
            shuffle(nextorder)
            shuffle(compatorder)
            order.push(0,nextorder[0],nextorder[1],goorder[0],goorder[1])
            compatibility.push(2,compatorder[0],compatorder[1],2,2)
            break;
          case 3:
            stage.push(0,1,1,1,2,2)
            trial.push(0,0,1,2,0,1)
            goorder = [0,1]
            nextorder = [0,1,0,1]
            compatorder = [0,1,0,1]
            shuffle(goorder)
            shuffle(nextorder)
            shuffle(compatorder)
            order.push(0,nextorder[0],nextorder[1],nextorder[2],goorder[0],goorder[1])
            compatibility.push(2,compatorder[0],compatorder[2],compatorder[2],2,2)
            break;
        }
        switch (miniblocklength[g]){
          case 0:
            blocktype.push(blocktype_iter[g],blocktype_iter[g],blocktype_iter[g])
            break;
          case 1:
            blocktype.push(blocktype_iter[g],blocktype_iter[g],blocktype_iter[g],
                            blocktype_iter[g])
            break;
          case 2:
            blocktype.push(blocktype_iter[g],blocktype_iter[g],blocktype_iter[g],
                            blocktype_iter[g],blocktype_iter[g])
            break;
          case 3:
            blocktype.push(blocktype_iter[g],blocktype_iter[g],blocktype_iter[g],
                            blocktype_iter[g],blocktype_iter[g],blocktype_iter[g])
            break;
        }
      }

      //----------------------Images-------------------------------//
      for (var g=0;g<numberminiblocks;g++){
        imageset = [random_img[(g*4)+0],random_img[(g*4)+1],
                    random_img[(g*4)+2],random_img[(g*4)+3]]

        switch (miniblocklength[g]){
          case 0:
            image1.push(imageset[0],imageset[0],imageset[0])
            image2.push(imageset[1],imageset[1],imageset[1])
            image3.push(imageset[2],imageset[2],imageset[2])
            image4.push(imageset[3],imageset[3],imageset[3])
            break;
          case 1:
            image1.push(imageset[0],imageset[0],imageset[0],
                        imageset[0])
            image2.push(imageset[1],imageset[1],imageset[1],
                        imageset[1])
            image3.push(imageset[2],imageset[2],imageset[2],
                        imageset[2])
            image4.push(imageset[3],imageset[3],imageset[3],
                        imageset[3])
            break;
          case 2:
            image1.push(imageset[0],imageset[0],imageset[0],
                        imageset[0],imageset[0])
            image2.push(imageset[1],imageset[1],imageset[1],
                        imageset[1],imageset[1])
            image3.push(imageset[2],imageset[2],imageset[2],
                        imageset[2],imageset[2])
            image4.push(imageset[3],imageset[3],imageset[3],
                        imageset[3],imageset[3])
            break;
          case 3:
            image1.push(imageset[0],imageset[0],imageset[0],
                        imageset[0],imageset[0],imageset[0])
            image2.push(imageset[1],imageset[1],imageset[1],
                        imageset[1],imageset[1],imageset[1])
            image3.push(imageset[2],imageset[2],imageset[2],
                        imageset[2],imageset[2],imageset[2])
            image4.push(imageset[3],imageset[3],imageset[3],
                        imageset[3],imageset[3],imageset[3])
            break;
        }
      }

      trialmatrix = [blocktype,image1,image2,image3,image4,trial,order,stage,compatibility]

      //Code that prints out the trial matrix to a file
      //download(trialmatrix, 'json.txt', 'text/plain');

    };

    //#######################################################//
    //------------------INITIALIZING VARIABLES---------------//
    //#######################################################//
    i=0;
    acccount = 0;
    acctotalcount = 0;
    notfullscreen = 0;
    instructionson = 0;
    block = -1;
    trialcount = 0;
    var totalcount = 0;
    var instructioncount = 0;
    stimscreencount = 0;

    //variables that just need to be
    type = 0;
    jokes = 0;

    //logfile
    var data=[['']];
    var runStart;
    var logCounter = 0;
    var onset;
    var d1;
    var checkResponse = false;
    var timeoutHandle = null;

    //#######################################################//
    //------------------EXPERIMENT SCREENS-------------------//
    //#######################################################//

    //--------------------Task Choice SCREENS--------------------//
    function task_choice(object1,object2,object3,object4){
      type = 1;
      key = {};
      d1 = new Date();
      onset = d1.getTime() - runStart;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //draw the left side instructions
      ctx.drawImage(img[object1], myCanvas.width/2-384, myCanvas.height/2-284);
      ctx.drawImage(img[object2], myCanvas.width/2-384, myCanvas.height/2+28);

      ctx.font="bold 45px Arial";
      ctx.textAlign="center";
      ctx.fillText("I",myCanvas.width/2-80,(myCanvas.height/2)-156);
      ctx.fillText("M",myCanvas.width/2-80,(myCanvas.height/2)+156);


      //draw the right side instructions
      ctx.drawImage(img[object3], myCanvas.width/2+128, myCanvas.height/2-284);
      ctx.drawImage(img[object4], myCanvas.width/2+128, myCanvas.height/2+28);

      ctx.font="bold 45px Arial";
      ctx.textAlign="center";
      ctx.fillText("I",myCanvas.width/2+80,(myCanvas.height/2)-156);
      ctx.fillText("M",myCanvas.width/2+80,(myCanvas.height/2)+156);

      //record presentation data
      data[logCounter] = ["CP:", ];
      logCounter++;

      //timeout variable
      stimscreencount = 1;
    };

    //--------------------Diagnostic SCREENS---------------------//
    function diagnostic(object,color){
      type = 1;
      key = {};
      d1 = new Date();
      onset = d1.getTime() - runStart;
      type = 1;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //draw the two WM cues for the block
      ctx.beginPath();
      ctx.rect(myCanvas.width/2-150, myCanvas.height/2-150, 300, 300);
      ctx.fillStyle = color
      ctx.fill();

      //draw the image for the diagnostic sreen
      ctx.drawImage(img[object], myCanvas.width/2-128, myCanvas.height/2-128);

      //record presentation data
      data[logCounter] = ["DP:", ];
      logCounter++;

      //timeout variable
      stimscreencount = 2;
    };

    //--------------------Inducer SCREENS---------------------//
    function inducer(object){
      type = 1;
      key = {};
      d1 = new Date();
      onset = d1.getTime() - runStart;
      type = 1;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //draw the image for the diagnostic sreen
      ctx.drawImage(img[object], myCanvas.width/2-128, myCanvas.height/2-128);

      //record presentation data
      data[logCounter] = ["IP:", ];
      logCounter++;

      //timeout variable
      stimscreencount = 3;
    };

    //-----------------------ITI SCREENS-------------------//
    function iti_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 45px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws fixation point
      ctx.fillText("⋅",myCanvas.width/2,(myCanvas.height/2));
      ctx.font="bold 20px Arial";

      //determines which feedback to give
      if (acc == 1) {
        ctx.fillText("Correct",myCanvas.width/2,(myCanvas.height/2)+15);
      }
      else if (acc == 0) {
        ctx.fillText("Incorrect",myCanvas.width/2,(myCanvas.height/2)+15);
      }
      else if (acc == 99) {
        ctx.fillText("Too Slow",myCanvas.width/2,(myCanvas.height/2)+15);
        //record presentation data
        data[logCounter] = ["DR:", ];
        logCounter++;
      }

      //timeout variable
      timeoutITI = setTimeout(runTrial,ITIinterval);
    };

    //-----------------------ISI SCREENS-------------------//
    function isi_screen(){
      type = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

      //sets up the text attributes
      ctx.font="bold 45px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      //draws fixation point
      ctx.fillText("⋅",myCanvas.width/2,(myCanvas.height/2));

      //timeout variable
      timeoutISI = setTimeout(runTrial,ISIinterval);
    };

    //-------------------COUNTDOWN SCREENS----------------//
    function countDown(time){
      type = 0;
      if (time > 0)
      {
        $("#startButton").hide();
        ctx.fillStyle = "white";
        ctx.font="60px Arial";
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.fillText(""+time, 450, 450);
        timeoutcountdown = setTimeout(function(){countDown(time-1)},750);
      }
      else
      {
        instructionson = 1;
        runTrial();
      }
    };

    //#######################################################//
    //-----------------INSTRUCTION SCREENS-------------------//
    //#######################################################//
    function instructions(){
      type = 1;
      key = {};
      stimscreencount = 0;
      document.getElementById("myCanvas").style.cursor = "pointer";
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";

      if (instructioncount == 0){
        ctx.font="bold 45px Arial";
        ctx.fillText("You will now begin the task.", (myCanvas.width/2), (myCanvas.height/2)-400);
        ctx.font="25px Arial";
        ctx.fillText("You will complete "+numberofblocks+" blocks of trials, taking ~30min in total.", (myCanvas.width/2), (myCanvas.height/2)-350);
        //ctx.fillText("At the beginning of each block you will be told your current accuracy.", (myCanvas.width/2), (myCanvas.height/2)-300);
        //ctx.fillText("Remember you need >75% accuracy in the task.", (myCanvas.width/2), (myCanvas.height/2)-270);
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-220);
        ctx.fillText("__________________________________________________________________________________", (myCanvas.width/2), (myCanvas.height/2)-200);
        ctx.textAlign="left";
        ctx.fillText("At the beginning of each sequence, you will be presented with two response", (0.0), (myCanvas.height/2)-150);
        ctx.fillText("mappings, one each on the left and right. You should select which mapping you", (0.0), (myCanvas.height/2)-120);
        ctx.fillText("would like to eventually implement using either the 'a', 's', 'k', or 'l' keys.", (0.0), (myCanvas.height/2)-90);
        ctx.fillText("    -- If you would like to select the mapping on the left, press 'a' or 's'.", (0.0), (myCanvas.height/2)-60);
        ctx.fillText("    -- If you would like to select the mapping on the left, press 'k' or 'l'.", 0, (myCanvas.height/2)-30);

        ctx.fillText("During the task sequence, if you see an image with a red or green border around it,", (0.0), (myCanvas.height/2)+20);
        ctx.fillText("do not respond to the image, but instead respond to the color.", (0.0), (myCanvas.height/2)+50);
        ctx.fillText("    -- Use your index fingers to press 's' and 'k' together if the border is red.", (0.0), (myCanvas.height/2)+80);
        ctx.fillText("    -- Use your middle fingers to press 'a' and 'l' together if the border is green.", (0.0), (myCanvas.height/2)+110);
        ctx.fillText("    -- fOtherwise, if there is no border, implement the mappings previously selected.", (0.0), (myCanvas.height/2)+140);

        ctx.textAlign="center";
        ctx.fillText("Press any button to begin the task.", (myCanvas.width/2), (myCanvas.height/2)+420);
      }

      if (instructioncount > 0){
        ctx.fillText("This is a short break. Your accuracy is: " +Math.round((acccount/acctotalcount)*100)+" %", (myCanvas.width/2), (myCanvas.height/2)-400);
        ctx.fillText("You have completed " +(block+1)+" of "+ numberofblocks + " blocks.", (myCanvas.width/2), (myCanvas.height/2)-360);
        ctx.fillText("Remember you need >75% accuracy in the task.", (myCanvas.width/2), (myCanvas.height/2)-320);
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-200);
        ctx.fillText("__________________________________________________________________________________", (myCanvas.width/2), (myCanvas.height/2)-180);
        ctx.textAlign="left";
        ctx.fillText("You will be presented with an array of numbers and letters in various colors.", (0.0), (myCanvas.height/2)-150);
        ctx.fillText("You will need to find an item of a certain color and press a button indicating", (0.0), (myCanvas.height/2)-120);
        ctx.fillText("whether that item is a letter or a number. ", (0.0), (myCanvas.height/2)-90);
        ctx.fillText("    -- If the item is a letter, press the '9' key (NOT using the numpad).", (0.0), (myCanvas.height/2)-60);
        ctx.fillText("    -- If the item is a number, press the '0' key (NOT using the numpad).", 0, (myCanvas.height/2)-30);

        ctx.fillText("On each trial, before you complete the search task, you will need to select which", (0.0), (myCanvas.height/2)+20);
        ctx.fillText("color you will search for. Two choices will appear on the screen. Sometimes your", (0.0), (myCanvas.height/2)+50);
        ctx.fillText("two options will be the same. However, when they are different, try to select to", (0.0), (myCanvas.height/2)+80);
        ctx.fillText("search for both colors every block.", (0.0), (myCanvas.height/2)+110);
        ctx.fillText("    -- To select the color option presented to the left, press the '1' key.", (0.0), (myCanvas.height/2)+140);
        ctx.fillText("    -- To select the color option presented to the right, press the '2' key.", (0.0), (myCanvas.height/2)+170);

        ctx.fillText("Your available choices of colors to search for each block will be presented to you", 0, (myCanvas.height/2)+220);
        ctx.fillText("at the beginning of the block. You will see two colored circles in the center of the.", 0, (myCanvas.height/2)+250);
        ctx.fillText("screen. Remember the colors of those circles.", 0, (myCanvas.height/2)+280);
        ctx.textAlign="center";
        ctx.fillText("Press any button to begin the task.", (myCanvas.width/2), (myCanvas.height/2)+420);
      }
    };

    //#######################################################//
    //-----------------------ERROR SCREENS-------------------//
    //#######################################################//

    //-----------------------NOT FULL SCREEN----------------//
    function nonfullscreen(){
      type = 2;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="bold 30px Arial";
      ctx.fillStyle="white";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      if (notfullscreen == 0){
        ctx.fillText("Your screen is not full screen.",myCanvas.width/2,myCanvas.height/2);
        ctx.fillText("Please correct this and press any key to continue.",myCanvas.width/2,(myCanvas.height/2)+50);
        ctx.fillText("If you exit full screen one more time during this experiment,",myCanvas.width/2,(myCanvas.height/2)+100);
        ctx.fillText("you will have to restart the experiment and will not be paid",myCanvas.width/2,(myCanvas.height/2)+150);
        ctx.fillText("for the previous time you have spent doing the experiment.",myCanvas.width/2,(myCanvas.height/2)+200);
        notfullscreen++;
      }
      else {ctx.fillText("Please refresh the page to restart the experiment.",myCanvas.width/2,myCanvas.height/2);
      notfullscreen++;
      }
    };

    //-----------------------CHECKS SIZE SCREEN----------------//
    function checkSize(){
      var w = window.innerWidth;
      var h = window.innerHeight;
      if (w < 800 || h < 600) // 800 by 600 is the lowest resolution on my laptop; seems like a good "minimum" (basically need 500 x 500 at least)
      {
        checkwindowsize = 1;
      }
      else // if their screen is the proper size...
      {
        checkwindowsize = 0;
      }
    };

    //#######################################################//
    //-----------------------RUN EXPERIMENT------------------//
    //#######################################################//
    function runTrial(){
        if (trialcount < numberminiblocks*4.5){
          if (trialcount+instructionson == 0) {
            i = 0; block++; key = {}; keys = []; respTime = {}; respTimes = []; createTrialMatrix(block); instructions();}

            //Present choice screen
            else if (trialmatrix[7][i] == 0 & instructionson == 1){checkSize();
                if (checkwindowsize == 0) {
                  if (trialmatrix[0][i] == 0){
                    task_choice(trialmatrix[1][i],trialmatrix[2][i],
                      trialmatrix[3][i],trialmatrix[4][i]);}
                  if (trialmatrix[0][i] == 1){
                    task_choice(trialmatrix[1][i],trialmatrix[2][i],
                      trialmatrix[1][i],trialmatrix[2][i]);}
                }
                else if (checkwindowsize == 1) {nonfullscreen();}
            }

            //Present the diagnostic
            else if (trialmatrix[7][i] == 1 & instructionson == 1){checkSize();
              if (checkwindowsize == 0) {
                if (trialmatrix[6][i] == 0){
                  if (trialmatrix[8][i] == 0){
                    color = '#006400'
                    if (trialmatrix[0][i] == 0){
                      diagnostic(trialmatrix[trialmatrix[6][i]+image_add+1][i],color);}
                    if (trialmatrix[0][i] == 1){
                      diagnostic(trialmatrix[trialmatrix[6][i]+1][i],color);}
                  }
                  if (trialmatrix[8][i] == 1){
                    color = '#ff0000'
                    if (trialmatrix[0][i] == 0){
                      diagnostic(trialmatrix[trialmatrix[6][i]+image_add+1][i],color);}
                    if (trialmatrix[0][i] == 1){
                      diagnostic(trialmatrix[trialmatrix[6][i]+1][i],color);}
                  }
                }
                if (trialmatrix[6][i] == 1){
                  if (trialmatrix[8][i] == 0){
                    color = '#ff0000'
                    if (trialmatrix[0][i] == 0){
                      diagnostic(trialmatrix[trialmatrix[6][i]+image_add+1][i],color);}
                    if (trialmatrix[0][i] == 1){
                      diagnostic(trialmatrix[trialmatrix[6][i]+1][i],color);}
                  }
                  if (trialmatrix[8][i] == 1){
                    color = '#006400'
                    if (trialmatrix[0][i] == 0){
                      diagnostic(trialmatrix[trialmatrix[6][i]+image_add+1][i],color);}
                    if (trialmatrix[0][i] == 1){
                      diagnostic(trialmatrix[trialmatrix[6][i]+1][i],color);}
                  }
                }
              }
              else if (checkwindowsize == 1) {nonfullscreen();}
            }

            //Present the inducer
            else if (trialmatrix[7][i] == 2 & instructionson == 1){checkSize();
              if (checkwindowsize == 0) {
                if (trialmatrix[0][i] == 0){
                  inducer(trialmatrix[trialmatrix[6][i]+image_add+1][i]);}
                if (trialmatrix[0][i] == 1){
                  inducer(trialmatrix[trialmatrix[6][i]+1][i]);}
              }
              else if (checkwindowsize == 1) {nonfullscreen();}
            }
          }
          else {
            //alert(data.join(";"));
            $("#info").css("color","white");
            //$("#info").show();
            $("#info").text(data.join(";"));
            //$("#mturk_form").show();
            $("#RTs", opener.window.document).val(data.join(";"));
            opener.updateMainMenu(4);
            JavaScript:window.close();
          }
        };


        //Detect events likes clicks or button presses
        $("body").keypress(function(event){
          //clearTimeout();
          if(type == 1) {
            //creates more data
            d1 = new Date();
            Ronset = d1.getTime()-runStart;
            respTime = Ronset-onset;
          };
        });

        $("body").keyup(function(event){
          //clearTimeout();
          if(type == 1) {
          key[event.keyCode] = event.type == 'keyup';
            for (var k in key){
              keys.push(k)
            }
          }
          if (type == 1) {
            if (stimscreencount == 0){
              countDown(3); keys = [];
            }
            if (stimscreencount == 1 & (key["75"] == true || key["76"] == true || key["65"] == true || key["83"] == true)){
              if(key["75"] == true || key["76"] == true){
                image_add = 2
              }
              if(key["65"] == true || key["83"] == true){
                image_add = 0
              }
              i++; isi_screen(); keys = [];
            }
            if (stimscreencount == 2 & keys.length > 1){
              i++; isi_screen(); keys = [];
            }
            if (stimscreencount == 3 & keys.length > 1){
              i++; isi_screen(); keys = [];
            }
          }
          else {jokes++;}
        });

        $("body").keydown(function(event){
          //clearTimeout();
          if(type == 1) {
            delete(key[event.which])
          };
        });

        //Start stuff
        $("#info").hide();
        $("#form").hide();
        $('#button').hide();
        $("#mturk_form").hide();
        d1 = new Date();
        runStart = d1.getTime();
        loadImage();

      });

      </script>
    </head>
    <body>
      <table>
        <tr>
          <td>
            <canvas id="myCanvas" width="900" height="900"> </canvas>
            <div style="text-align:center; align:center;">
            </div>
            <div style="text-align:center;">
              <button id="startButton">Start</button>
            </div>
            <div style="text-align:center;">
              <button id="button">NEXT</button>
            </div>
            <form id="form" onsubmit="return false;">
              <input   style=position:absolute;top:80%;left:40%;width:10%; type="text" id="userInput">
            </form>
            <form id="mturk_form" method="POST" action="http://152.3.33.14/AMTSubmit/dataHandler.php">
              <!-- <form id="mturk_form" method="POST" action="https://workersandbox.mturk.com/mturk/externalSubmit"> -->
              <!-- <form id="mturk_form" method="POST" action="https://wwww.mturk.com/mturk/externalSubmit"> -->
              <input type="hidden" id="assignmentId" name="assignmentId" value="">
              <input type="hidden" id="workerId" name="workerId" value="">
              <input type="hidden" id="hitId" name="hitId" value="">
              <input type="hidden" id="RTs" name="RTs" value="">
              <input type="hidden" id="demographics" name="demographics" value="freeforcedinstruct">
              <input type="hidden" id="ExpName" name="ExpName" value="freeforcedinstruct">
            </form>
          </td>
        </tr>
      </table>
    </body>
    </html>
