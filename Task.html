<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="NEXT.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="jquery-3.1.1.js"></script>
  <script type="text/javascript" src="wordlist.js"></script>
  <script type="text/javascript">

$(document).ready(function(){

  var c = document.getElementById("myCanvas");
  var ctx = c.getContext("2d");

  //logfile
    var data=[['']];
    var runStart;
    var logCounter = 0;
    var onset;
    var d1;
    var checkResponse = false;
    var timeoutHandle = null;

  //Experiment Parameters
    var i = 0;
    var w = 0;
    var b = 0;
    var acccount = 0;
    var acctotalcount = 0;
    var stimscreencount = 0;
    var instructionsfirst = 0;
    var ITIinterval = 500; //Inter-trial-interval in milliseconds
    var blocklength = 32;
    var counter = 0;
    var numberofblocks = 4;
    var block = 0;
    var instructioninterval = 25000;
    var color = ["red", "blue"]
    var allwords = words;
    var dummywords = words2;
    var jokes = 0;
    showblock = 0;
    var proportion = 1;

    shuffle(allwords)
    shuffle(dummywords)

    proportioncount = [];
    proportionstart = [0,1];
    shuffle(proportionstart)
    g = proportionstart[0];
    for (var x=0;x<numberofblocks;x++) {
      if (g > 1){g = 0;}
      proportioncount.push(g);
      g++;
    };

    GOtrial = [];
    for (var x=0;x<blocklength;x++) {
      GOtrial.push(2);
    };

    NEXTtrial = [];
    g = 0;
    for (var x=0;x<blocklength;x++) {
      if (g > 3){g = 0;}
      NEXTtrial.push(g);
      g++;
    };
    shuffle(NEXTtrial)

    function showinstructions(){
      type = 4;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        if (instructionsfirst == 0){
          instructioninterval = 25000;

        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="25px Arial";
        ctx.fillStyle="black";
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-300);
        ctx.fillText("You have 25 seconds to read these instructions.", (myCanvas.width/2), (myCanvas.height/2)-240);
        ctx.fillText("Instruction screens after this will be shorter.", (myCanvas.width/2), (myCanvas.height/2)-190);
        ctx.fillText("FOR THE ENTIRE TASK, when the words appear in                                   press D", (myCanvas.width/2)-50, (myCanvas.height/2)+100)
        ctx.fillText("When the words appear in                                  , follow the instructions below:", (myCanvas.width/2), (myCanvas.height/2)-100);
        ctx.font="bold 25px Arial";
        ctx.fillText("If you see the word: '" +compatibleword+ "' then press D", (myCanvas.width/2), (myCanvas.height/2)-50);
        ctx.fillText("If you see the word: '"+incompatibleword+ "' then press J", (myCanvas.width/2), (myCanvas.height/2));

        ctx.font="bold 50px Arial";
        ctx.fillStyle=color[0];
        ctx.fillText("this color", (myCanvas.width/2)+200, (myCanvas.height/2)+100);

        ctx.fillStyle=color[1];
        ctx.fillText("this color", (myCanvas.width/2)-15, (myCanvas.height/2)-100);
      }
      if (instructionsfirst == 1){
        instructioninterval = 5000;

        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="25px Arial";
        ctx.fillStyle="black";
        ctx.textBaseline="middle";
        ctx.textAlign="left";
        ctx.fillText("If                                     press D", (myCanvas.width/2)-300, (myCanvas.height/2)-50);
        ctx.fillText("If                                     press J", (myCanvas.width/2)-300, (myCanvas.height/2));
        ctx.font="bold 50px Arial";
        ctx.fillStyle=color[1];
        ctx.fillText(compatibleword, (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(incompatibleword, (myCanvas.width/2)-280, (myCanvas.height/2));
    }
        //stimscreencount++;
        instructionsfirst = 1;
        instructiontimeout = setTimeout(showITI,instructioninterval);
    };

    function runGOtest(){
      type = 3;
      d1 = new Date();
      onset = d1.getTime() - runStart;
      data[logCounter] = ["GOtest:", d1, onset, block, compatibleword, incompatibleword, dummyword1, dummyword2, GOtest[iGt], proportioncount[block], proportionGO[i]] ;
      logCounter++;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="25px Arial";
      ctx.fillStyle="black";
      ctx.textBaseline="middle";
      ctx.textAlign="left";
      ctx.fillText("If                                     press D", (myCanvas.width/2)-300, (myCanvas.height/2)-50);
      ctx.fillText("If                                     press J", (myCanvas.width/2)-300, (myCanvas.height/2));
      ctx.textAlign="center";
      ctx.fillText("For the above instructions, in comparison to", (myCanvas.width/2), (myCanvas.height/2)+150);
      ctx.fillText("the instructions you are currently remembering:", (myCanvas.width/2), (myCanvas.height/2)+200);
      ctx.fillText("Both 'word+response' key mappings are the same = T", (myCanvas.width/2), (myCanvas.height/2)+250);
      ctx.fillText("Only one 'word+response' key mappings is the same = G", (myCanvas.width/2), (myCanvas.height/2)+300);
      ctx.fillText("Neither 'word+response' key mappings are the same = B", (myCanvas.width/2), (myCanvas.height/2)+350);
      ctx.textAlign="left";

      ctx.font="bold 50px Arial";
      ctx.fillStyle=color[1];
      switch (GOtest[iGt]){
        case 0:
        ctx.fillText(compatibleword, (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(incompatibleword, (myCanvas.width/2)-280, (myCanvas.height/2));
        break;

        case 1:
        ctx.fillText(dummyword1, (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(incompatibleword, (myCanvas.width/2)-280, (myCanvas.height/2));
        break;

        case 2:
        ctx.fillText(compatibleword, (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(dummyword1, (myCanvas.width/2)-280, (myCanvas.height/2));
        break;

        case 3:
        ctx.fillText(dummyword1, (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(dummyword2, (myCanvas.width/2)-280, (myCanvas.height/2));
        break;
      }
    };

    function runGOtrial(){
      type = 2;
      d1 = new Date();
      onset = d1.getTime() - runStart;
      data[logCounter] = ["GOtrial:", d1, onset, block, compatibleword, incompatibleword, iG, GOtrial[i], GOcongruency[iG], proportioncount[block], proportionGO[i]] ;
      logCounter++;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="bold 80px Arial";
      ctx.fillStyle="blue";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      switch (GOcongruency[iG]){
        case 0:
        ctx.fillText(compatibleword, (myCanvas.width/2), (myCanvas.height/2));
        break;

        case 1:
        ctx.fillText(incompatibleword, (myCanvas.width/2), (myCanvas.height/2));
        break;
      }
    };

    function runNEXTtrial(){
      type = 1;
      d1 = new Date();
      onset = d1.getTime() - runStart;
      data[logCounter] = ["NEXTtrial:", d1, onset, block, compatibleword, incompatibleword, iN, NEXTtrial[i], NEXTcongruency[iN], proportioncount[block], proportionGO[i]] ;
      logCounter++;
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      ctx.font="bold 80px Arial";
      ctx.fillStyle="red";
      ctx.textBaseline="middle";
      ctx.textAlign="center";
      switch (NEXTcongruency[iN]){
        case 0:
        ctx.fillText(compatibleword, (myCanvas.width/2), (myCanvas.height/2));
        break;

        case 1:
        ctx.fillText(incompatibleword, (myCanvas.width/2), (myCanvas.height/2));
        break;
      }
    };

    function showITI(){
      type = 4;
      if(stimscreencount == 1){
        stimscreencount++;
        ITIinterval = 500;
        $("#startButton").hide();
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="bold 50px Arial";
        ctx.fillStyle="black";
        ctx.fillText("*",(myCanvas.width)/2,(myCanvas.height)/2);
        countDown(3);}
      else {
        if (stimscreencount == 0){ITIinterval = 750;}
        $("#startButton").hide();
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="bold 50px Arial";
        ctx.fillStyle="black";
        ctx.fillText("*",(myCanvas.width)/2,(myCanvas.height)/2);
        setTimeout(runTrial,ITIinterval);
      }
    };

    function countDown(time)
    {
      type = 4;
      if (time > 0)
      {
        $("#startButton").hide();
        ctx.fillStyle = "black";
        ctx.font="60px Arial";
        ctx.clearRect(0,0, myCanvas.width, myCanvas.height);
        ctx.fillText(""+time, myCanvas.width/2, myCanvas.height/2);
        setTimeout(function(){countDown(time-1)},750);
      }
      else
      {
        runTrial();
      }
    };


    function setvalues(){
      if (counter == blocklength){
        shuffle(NEXTtrial)
        counter = 0;
        i = 0;
        block++;
        switch (proportioncount[block]){
          case 0:
          proportionGO = [];
          g = 0;
          for (var x=0;x<blocklength;x++) {
            if (x > (blocklength*proportion)){g = 1;}
            proportionGO.push(g);
          };
          shuffle(proportionGO)
          break;

          case 1:
          proportionGO = [];
          g = 1;
          for (var x=0;x<blocklength;x++) {
            if (x > (blocklength*proportion)){g = 0;}
            proportionGO.push(g);
          };
          shuffle(proportionGO)
          break;
          }
        }
        if (instructionsfirst == 0){
          switch (proportioncount[block]){
            case 0:
            proportionGO = [];
            g = 0;
            for (var x=0;x<blocklength;x++) {
              if (x > (blocklength*proportion)){g = 1;}
              proportionGO.push(g);
            };
            shuffle(proportionGO)
            break;

            case 1:
            proportionGO = [];
            g = 1;
            for (var x=0;x<blocklength;x++) {
              if (x > (blocklength*proportion)){g = 0;}
              proportionGO.push(g);
            };
            shuffle(proportionGO)
            break;
            }
          }
      instructioninterval = 5000;
      iN = 0;
      iGt = 0;
      iG = 0;
      compatibleword = allwords[w]
      incompatibleword =allwords[w+1]
      dummyword1 = dummywords[w]
      dummyword2 = dummywords[w+1]

      NEXTcongruency = [];
      if (NEXTtrial[i] % 2 === 0){
        g = 0;
        for (var x=0;x<(NEXTtrial[i]);x++) {
        if (g > 1){g = 0;}
        NEXTcongruency.push(g);
        g++;
      };
    }
    else if (NEXTtrial[i] % 2 != 0){
      pickg = [0,1];
      shuffle(pickg);
      g = pickg[0];
      for (var x=0;x<(NEXTtrial[i]);x++) {
        if (g > 1){g = 0;}
        NEXTcongruency.push(g);
        g++;
      };
    }
      shuffle(NEXTcongruency)

      GOcongruency = [];
      g = 0;
      for (var x=0;x<2;x++) {
        if (g > 1){g = 0;}
        GOcongruency.push(g);
        g++;
      };
      shuffle(GOcongruency)

      GOtest = [];
      g = 0;
      for (var x=0;x<4;x++) {
        if (g > 3){g = 0;}
        GOtest.push(g);
        g++;
      };
      shuffle(GOtest)

      stimscreencount++;
    };

    function runTrial(){
      if (b < blocklength*numberofblocks){
        if (b % blocklength === 0 && b != 0 && showblock == 0){
          showblock = 1;
    				var input=prompt("This is the end of block " +(block+1)+ " of " +numberofblocks+ "\n Your accuracy is "+Math.round((acccount/acctotalcount)*100)+ "% \n Press ENTER to continue.");
          }
        if (stimscreencount == 0){setvalues();}
        if (stimscreencount == 1){showinstructions();}
        if (stimscreencount == 2){
          if (NEXTtrial[i] == 0) {stimscreencount = 3; runTrial();}
          else {runNEXTtrial();}
        }
        if (stimscreencount == 3){
          if (proportionGO[i] == 0){runGOtrial();}
          else if (proportionGO[i] == 1){runGOtest();}
        }
        }
        else {
          {
            //alert(data.join(";"));
            $("#info").css("color","white");
            //$("#info").show();
            $("#info").text(data.join(";"));
            //$("#mturk_form").show();
            $("#RTs", opener.window.document).val(data.join(";"));
            opener.updateMainMenu(4);
            JavaScript:window.close();
          }
        }
      };



    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;
      // While there remain elements to shuffle...
      while (0 !== currentIndex) {
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    };

    $("body").keypress(function(event){
      if (type == 1 || type == 2 || type == 3){key = String.fromCharCode(event.which);}
      else {key = 0}
      d1 = new Date();
      Ronset = d1.getTime()-runStart;
      respTime = Ronset-onset;
    });

    $("body").keyup(function(event){
      acc = 0;
      if (type == 1){
        if(key == "d" || key == "D"){
        if (iN < NEXTtrial[i]-1){
          if (key == "d" || key == "D"){acc = 1;};
          data[logCounter] = ["NR:", block, Ronset, key, respTime, acc, iN, NEXTtrial[i], NEXTcongruency[iN], proportioncount[block], proportionGO[i]];
          logCounter++;
          iN++; showITI();}
        else if (iN == NEXTtrial[i]-1){
          if (key == "d" || key == "D"){acc = 1;};
          data[logCounter] = ["NR:", block, Ronset, key, respTime, acc, iN, NEXTtrial[i], NEXTcongruency[iN], proportioncount[block], proportionGO[i]];
          logCounter++;
          stimscreencount++; showITI();}
        }
        else {jokes++;}
      }
      if (type == 2){
        acctotalcount++;
        if(key == "d" || key == "D" || key == "j" || key == "J"){
        if (iG < GOtrial[i]-1){
          if (GOcongruency[iG] == 0 & (key == "d" || key == "D")){acc = 1; acccount++;};
          if (GOcongruency[iG] == 1 & (key == "j" || key == "J")){acc = 1; acccount++;};
          data[logCounter] = ["GR:", block, Ronset, key, respTime, acc, iG, GOtrial[i], GOcongruency[iG], proportioncount[block], proportionGO[i]];
          logCounter++;
          iG++; showITI();}
        else if (iG == GOtrial[i]-1){
          if (GOcongruency[iG] == 0 & (key == "d" || key == "D")){acc = 1; acccount++;};
          if (GOcongruency[iG] == 1 & (key == "j" || key == "J")){acc = 1; acccount++;};
          data[logCounter] = ["GR:", block, Ronset, key, respTime, acc, iG, GOtrial[i], GOcongruency[iG], proportioncount[block], proportionGO[i]];
          logCounter++;
          stimscreencount = 0; i++; counter++; w++; w++; b++; showblock = 0; showITI();}
      }
      else {jokes++;}
    }
      if (type == 3){
        acctotalcount++;acctotalcount++;
        if (key == "t" || key == "T" || key == "g" || key == "G" || key == "b" || key == "B"){
        if (GOtest[iGt] == 0 & (key == "t" || key == "T")){acc = 1; acccount++;acccount++;};
        if (GOtest[iGt] == 1 & (key == "g" || key == "G")){acc = 1; acccount++;acccount++;};
        if (GOtest[iGt] == 2 & (key == "g" || key == "G")){acc = 1; acccount++;acccount++;};
        if (GOtest[iGt] == 3 & (key == "b" || key == "B")){acc = 1; acccount++;acccount++;};
        data[logCounter] = ["GtR:", block, Ronset, key, respTime, acc, iGt, GOtest[iGt], proportioncount[block], proportioncount[block], proportionGO[i]];
        logCounter++;
        stimscreencount = 0; i++; counter++; w++; w++; b++; showITI();}
        else {jokes++;}
      }
      if (type == 4){jokes++;}
    });

    $("#info").hide();
    $("#mturk_form").hide();
    $("#startButton").hide();
    d1 = new Date();
    runStart = d1.getTime();
    runTrial();

        });

        </script>
      </head>
      <body>
        <table>
          <tr>
            <td>
              <canvas id="myCanvas" width="900" height="900"> </canvas>
              <div style="text-align:center; align:center;">
              </div>
              <div style="text-align:center;">
                <button id="startButton">Start</button>
              </div>
              <form id="mturk_form" method="POST" action="http://152.3.33.45/AMTSubmit/dataHandler.php">
                  <input type="hidden" id="assignmentId" name="assignmentId" value="">
                  <input type="hidden" id="workerId" name="workerId" value="">
                  <input type="hidden" id="hitId" name="hitId" value="">
                  <input type="hidden" id="RTs" name="RTs" value="">
                  <input type="hidden" id="ExpName" name="ExpName" value="NEXT">
                  <p style="font-family: Arial; color: black; font-size:24px">Click button to submit</p>
                  <input id="submitButton" type="submit" name="Finish" value="Submit">
                </td>
              </tr>
            </table>
          </body>
          </html>
