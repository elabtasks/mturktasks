<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="NEXT.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="jquery-3.1.1.js"></script>
  <script type="text/javascript" src="wordlist.js"></script>
  <script type="text/javascript">

  /*function gup(name, tmpURL)
  {
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(tmpURL);
  if (results == null)
  {
  return "";
}
else
{
return results[1];
}
}*/

$(document).ready(function(){

  var c = document.getElementById("myCanvas");
  var ctx = c.getContext("2d");

  //Experiment Parameters

    var ITIinterval = 500; //Inter-trial-interval in milliseconds
    var blocklength = 100;
    var numberofblocks = 6;
    var block = 0;
    var instructioninterval = 2000;
    var firstinstructioninterval = 2000;
    var secondinstructioninterval = 2000;

    GOtrial = [];
    for (var x=0;x<=blocklength;x++) {
      GOtrial.push(2);
    }

    NEXTtrial = [];
    g = 0;
    for (var x=0;x<=blocklength;x++) {
      if (g > 5){g = 0;}
      NEXTtrial.push(g);
      g++;
    }


    var highlow = [
      [[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],
      [[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],
      [[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],[[1],[0]],
      [[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],
      [[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],
      [[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],[[1],[1]],
      [[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],
      [[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],
      [[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],[[1],[2]],
      [[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],
      [[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],
      [[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],[[1],[3]],
      [[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],
      [[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],
      [[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],[[0],[0]],
      [[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],
      [[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],
      [[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],[[0],[1]],
      [[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],
      [[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],
      [[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],[[0],[2]],
      [[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]],
      [[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]],
      [[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]],[[0],[3]]
    ]

    random = [];
    highAseq = [];
    highBseq = [];
    lowAseq = [];
    lowBseq = [];

    for (var highA=0;highA<=29;highA++){highAseq.push(highA)}
    shuffle(highAseq)
    for (var highB=30;highB<=59;highB++){highBseq.push(highB)}
    shuffle(highBseq)
    for (var lowA=60;lowA<=89;lowA++){lowAseq.push(lowA)}
    shuffle(lowAseq)
    for (var lowB=90;lowB<=119;lowB++){lowBseq.push(lowB)}
    shuffle(lowBseq)

    sequence = [];
    for (var sequencex=0;sequencex<=23;sequencex++) {
      sequence.push(sequencex);
    }
    shuffle(sequence)

switch(sequence[1]){
  case 0:
    random = highAseq.concat(highBseq, lowAseq, lowBseq);
    break;
    case 1:
    random = highAseq.concat(highBseq, lowBseq, lowAseq);
break;
    case 2:
    random = highAseq.concat(lowAseq, lowBseq, highBseq);
break;
    case 3:
    random = highAseq.concat(lowAseq, highBseq, lowBseq);
break;
    case 4:
    random = highAseq.concat(lowBseq, highBseq, lowAseq);
break;
    case 5:
    random = highAseq.concat(lowBseq, lowAseq, highBseq);
break;
case 6:
    random = highBseq.concat(highAseq, lowAseq, lowBseq);
break;
    case 7:
    random = highBseq.concat(highAseq, lowBseq, lowAseq);
break;
    case 8:
    random = highBseq.concat(lowAseq, lowBseq, highAseq);
break;
    case 9:
    random = highBseq.concat(lowAseq, highAseq, lowBseq);
break;
    case 10:
    random = highBseq.concat(lowBseq, highAseq, lowAseq);
    break;
    case 11:
    random = highBseq.concat(lowBseq, lowAseq, highAseq);
break;
case 12:
    random = lowAseq.concat(highAseq, highBseq, lowBseq);
break;
    case 13:
    random = lowAseq.concat(highAseq, lowBseq, highBseq);
break;
    case 14:
    random = lowAseq.concat(highBseq, lowBseq, highBseq);
break;
    case 15:
    random = lowAseq.concat(highBseq, highBseq, lowBseq);
break;
    case 16:
    random = lowAseq.concat(lowBseq, highBseq, lowAseq);
break;
    case 17:
    random = lowAseq.concat(lowBseq, lowAseq, highBseq);
break;
    case 18:
    random = lowBseq.concat(highAseq, highBseq, lowAseq);
break;
    case 19:
    random = lowBseq.concat(highAseq, lowAseq, highBseq);
break;
    case 20:
    random = lowBseq.concat(highBseq, lowAseq, highBseq);
break;
    case 21:
    random = lowBseq.concat(highBseq, highBseq, lowAseq);
break;
    case 22:
    random = lowBseq.concat(lowAseq, highBseq, lowAseq);
break;
    case 23:
    random = lowBseq.concat(lowAseq, lowAseq, highBseq);
    break;
  }

    var trialtype = [[[2],[2]],
    [[1,1,0],[0,0,1]],
    [[1,1,1,0],[0,0,0,1]],
    [[1,1,1,1,0],[0,0,0,0,1]]];
    var GOtrialtype = [0,1];
    var color = ["red", "blue"]
    var congruentword = words

    shuffle(GOtrial)
    shuffle(congruentword)
    //shuffle(random)

    //Initialize and reset counters
    var time = 0;
    var b = 0;
    var nt = 0;
    var gt = 0;
    var i = 0;
    var j = 0;
    var w = 0; //denotes the word/letter stimuli
    l = 0;
    var instructions = 0;
    var count = 0;
    var jokes = 0;

    //logfile
    var data=[['']];
    var runStart;
    var logCounter = 0;
    var onset;
    var d1;
    var checkResponse = false;
    var timeoutHandle = null;

    function blockinstruction(){
      type = 2;
      var instructions = 0;
      $("#startButton").hide();
      if (count == 0){
        //instructions++;
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="25px Arial";
        ctx.fillStyle="black";
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-300);
        ctx.fillText("You have 30 seconds to read these instructions.", (myCanvas.width/2), (myCanvas.height/2)-240);
        ctx.fillText("Pressing any button will restart the 30 second timer.", (myCanvas.width/2), (myCanvas.height/2)-190);
        ctx.fillText("When the words appear in                                   press D", (myCanvas.width/2)-50, (myCanvas.height/2)+100)
        ctx.fillText("When the words appear in                                  , follow the instructions below:", (myCanvas.width/2), (myCanvas.height/2)-100);
        ctx.font="bold 25px Arial";
        ctx.fillText("If you see the word: '" +congruentword[w]+ "' then press D", (myCanvas.width/2), (myCanvas.height/2)-50);
        ctx.fillText("If you see the word: '"+congruentword[w+1]+ "' then press J", (myCanvas.width/2), (myCanvas.height/2));

        ctx.font="bold 50px Arial";
        ctx.fillStyle=color[j];
        ctx.fillText("this color", (myCanvas.width/2)+54, (myCanvas.height/2)+100);

        ctx.fillStyle=color[j+1];
        ctx.fillText("this color", (myCanvas.width/2)-15, (myCanvas.height/2)-100);

      }
      else if (count == 1){
        //instructions++;
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="25px Arial";
        ctx.fillStyle="black";
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText("Please answer as quickly and accurately as possible.", (myCanvas.width/2), (myCanvas.height/2)-300);
        ctx.fillText("You have 30 seconds to read these instructions.", (myCanvas.width/2), (myCanvas.height/2)-240);
        ctx.fillText("Instruction screens after this will be shorter.", (myCanvas.width/2), (myCanvas.height/2)-190);
        ctx.fillText("When the words appear in                                   press D", (myCanvas.width/2)-50, (myCanvas.height/2)+100)
        ctx.fillText("When the words appear in                                  , follow the instructions below:", (myCanvas.width/2), (myCanvas.height/2)-100);
        ctx.font="bold 25px Arial";
        ctx.fillText("If you see the word: '" +congruentword[w]+ "' then press D", (myCanvas.width/2), (myCanvas.height/2)-50);
        ctx.fillText("If you see the word: '"+congruentword[w+1]+ "' then press J", (myCanvas.width/2), (myCanvas.height/2));

        ctx.font="bold 50px Arial";
        ctx.fillStyle=color[j];
        ctx.fillText("this color", (myCanvas.width/2)+54, (myCanvas.height/2)+100);

        ctx.fillStyle=color[j+1];
        ctx.fillText("this color", (myCanvas.width/2)-15, (myCanvas.height/2)-100);

      }
      else {
        //instructions++;
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="25px Arial";
        ctx.fillStyle="black";
        ctx.textBaseline="middle";
        ctx.textAlign="left";
        ctx.fillText("If                                     press D", (myCanvas.width/2)-300, (myCanvas.height/2)+100)
        ctx.font="bold 25px Arial";
        ctx.fillText("If                                     press D", (myCanvas.width/2)-300, (myCanvas.height/2)-50);
        ctx.fillText("If                                     press J", (myCanvas.width/2)-300, (myCanvas.height/2));

        ctx.font="bold 50px Arial";
        ctx.fillStyle=color[j];
        ctx.fillText("this color", (myCanvas.width/2)-260, (myCanvas.height/2)+100);
        ctx.fillStyle=color[j+1];
        ctx.fillText(congruentword[w], (myCanvas.width/2)-280, (myCanvas.height/2)-50);
        ctx.fillText(congruentword[w+1], (myCanvas.width/2)-280, (myCanvas.height/2));

      }
      if (count < 2){
        timeout = setTimeout(showITI500,firstinstructioninterval)
      }
      else if (count < 4){
        timeout = setTimeout(showITI500,secondinstructioninterval)
      }
      else {
        timeout = setTimeout(showITI500,instructioninterval)
      }
    }

    function countDown(time)
    {
      type = 3;
      if (time > 0)
      {
        $("#startButton").hide();
        ctx.fillStyle = "black";
        ctx.font="60px Arial";
        ctx.clearRect(0,0, myCanvas.width, myCanvas.height);
        ctx.fillText(""+time, myCanvas.width/2, myCanvas.height/2);
        setTimeout(function(){countDown(time-1)},1000);
      }
      else
      {
        runTrial();
      }
    };

    function runNEXT(){
      type = 0;
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      switch (trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i]){
        case 0:
        d1 = new Date();
        onset = d1.getTime() - runStart;
        data[logCounter] = ["NEXT:", onset, trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j], congruentword[w]] ;
        logCounter++;
        ctx.font="bold 150px Arial";
        ctx.fillStyle=color[j];
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText(congruentword[w],(myCanvas.width)/2,(myCanvas.height)/2);
        break;

        case 1:
        d1 = new Date();
        onset = d1.getTime() - runStart;
        data[logCounter] = ["NEXT:", onset, trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j], congruentword[w+1]] ;
        logCounter++;
        ctx.font="bold 150px Arial";
        ctx.fillStyle=color[j];
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText(congruentword[w+1],(myCanvas.width)/2,(myCanvas.height)/2);
        break;

        case 2:
        nt = 5000;
        break;

      }
    };

    function runGO(){
      type = 1;
      $("#startButton").hide();
      ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
      switch (GOtrialtype[i]){

        case 0:
        d1 = new Date();
        onset = d1.getTime() - runStart;
        if ( i == 0){
          data[logCounter] = ["GO:", onset, GOtrialtype[i], trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j+1], congruentword[w]] ;
          logCounter++;
        }
        else if ( i == 1){
          data[logCounter] = ["GO:", onset, GOtrialtype[i], trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j+1], congruentword[w]] ;
          logCounter++;
        }
        ctx.font="bold 150px Arial";
        ctx.fillStyle=color[j+1];
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText(congruentword[w],(myCanvas.width)/2,(myCanvas.height)/2);
        break;

        case 1:
        d1 = new Date();
        onset = d1.getTime() - runStart;
        if ( i == 0){
          data[logCounter] = ["GO:", onset, GOtrialtype[i], trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j+1], congruentword[w]] ;
          logCounter++;
        }
        else if ( i == 1){
          data[logCounter] = ["GO:", onset, GOtrialtype[i], trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i-1], highlow[random[l]][1][0], highlow[random[l]][0][0], color[j+1], congruentword[w]] ;
          logCounter++;
        }
        ctx.font="bold 150px Arial";
        ctx.fillStyle=color[j+1];
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.fillText(congruentword[w+1],(myCanvas.width)/2,(myCanvas.height)/2);
        break;
      }
      i++;
    };

    function runTrial(){
      if (b < random.length){
        if (instructions < 1){
          //shuffle(GOtrialtype);
          blockinstruction();
        }
        else if (nt < 0 && highlow[random[l]][1][0] == 0){
          if (nt == 0){shuffle(trialtype[3][1])
          shuffle(trialtype[3][0])
          shuffle(trialtype[2][1])
          shuffle(trialtype[2][0])
          shuffle(trialtype[1][1])
          shuffle(trialtype[1][0])}
          runNEXT();}
        //else if (nt < 1 && NEXTtrial[l] == 1){runNEXT();}
        else if (nt < highlow[random[l]][1][0]+2 && highlow[random[l]][1][0] != 0 /*&& NEXTtrial[l] != 1*/){
        if (nt == 0){shuffle(trialtype[3][1])
        shuffle(trialtype[3][0])
        shuffle(trialtype[2][1])
        shuffle(trialtype[2][0])
        shuffle(trialtype[1][1])
        shuffle(trialtype[1][0])}
          runNEXT();}
        else if (gt < GOtrial[l]) {
          if (gt < 1){i=0; shuffle(GOtrialtype)}
          runGO();
        }
        else {i = 0; nt =0; gt = 0; instructions = 0;
          b++; j++; j++; l++; w++; w++; count++;
          if (j > color.length-1){j=0;}
          runTrial();}
        }
        else {
          {
            //alert(data.join(";"));
            $("#info").css("color","white");
            //$("#info").show();
            $("#info").text(data.join(";"));
            //$("#mturk_form").show();
            $("#RTs", opener.window.document).val(data.join(";"));
            opener.updateMainMenu(3);
            JavaScript:window.close();
          }
        }
      };

      function showITI500(){

        $("#startButton").hide();
        ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        ctx.font="bold 50px Arial";
        ctx.fillStyle="black";
        ctx.fillText("*",(myCanvas.width)/2,(myCanvas.height)/2);
        instructions++;
        if (count < 2 && i == 0){
          countDown(5)
        }
        else if (count >= 2 && i == 0){
          countDown(3)
        }
        else {
          setTimeout(runTrial,ITIinterval);
        }
      };

      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;
        // While there remain elements to shuffle...
        while (0 !== currentIndex) {
          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;
          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
        return array;
      }


      $("body").keypress(function(event){
        //clearTimeout();
        key = String.fromCharCode(event.which);
        //creates more data
        d1 = new Date();
        Ronset = d1.getTime()-runStart;
        respTime = Ronset-onset;
        acc = 0;
        block = 0;

        if (random [l-1] >= 0 && random [l-1] <= 29){block = 1}
        else if (random [l-1] >= 30 && random [l-1] <= 59){block = 2}
        else if (random [l-1] >= 60 && random [l-1] <= 89){block = 3}
        else if (random [l-1] >= 90 && random [l-1] <= 119){block = 4}

        if (type == 0 && key == "d" || type == 0 && key == "D"){acc = 1;}
        else if (type == 1) {
          if (GOtrialtype[i-1] == 1 && key == "j" || GOtrialtype[i-1] == 1 && key == "J"){acc = 1;}
          else if (GOtrialtype[i-1] == 0 && key == "d" || GOtrialtype[i-1] == 0 && key == "D"){acc = 1;}
        }
        if (type == 0){
          data[logCounter] = ["NR:", Ronset, key, respTime, acc, trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i], highlow[random[l]][1][0], highlow[random[l]][0][0]];
          logCounter++;
        }
        else if (type == 1){
          data[logCounter] = ["GR:", Ronset, key, respTime, acc, trialtype[highlow[random[l]][1][0]][highlow[random[l]][0][0]][i-1], highlow[random[l]][1][0], highlow[random[l]][0][0]];
          logCounter++;
        }
        switch (type){
          case 0: nt++; i++; break;
          case 1: gt++; break;
          case 2: instructions++; break;
        }
        if (type == 0 | type == 1){showITI500();}
        else if (type == 2) {clearTimeout(timeout); blockinstruction();}
        else if (type == 3) { jokes = 10;}
      });
      $("#info").hide();
      $("#mturk_form").hide();
      d1 = new Date();
      runStart = d1.getTime();
      runTrial();

    });

    </script>
  </head>
  <body>
    <table>
      <tr>
        <td>
          <canvas id="myCanvas" width="900" height="900"> </canvas>
          <div style="text-align:center; align:center;">
          </div>
          <div style="text-align:center;">
            <button id="startButton">Start</button>
          </div>
          <form id="mturk_form" method="POST" action="http://152.3.33.45/AMTSubmit/dataHandler.php">
            <form id="mturk_form" method="POST" action="https://workersandbox.mturk.com/mturk/externalSubmit">
              <input type="hidden" id="assignmentId" name="assignmentId" value="">
              <input type="hidden" id="workerId" name="workerId" value="">
              <input type="hidden" id="hitId" name="hitId" value="">
              <input type="hidden" id="RTs" name="RTs" value="">
              <input type="hidden" id="ExpName" name="ExpName" value="NEXT">
              <p style="font-family: Arial; color: black; font-size:24px">Click button to submit</p>
              <input id="submitButton" type="submit" name="Finish" value="Submit">
            </td>
          </tr>
        </table>
      </body>
      </html>
